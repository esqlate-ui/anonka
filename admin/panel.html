<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Anonka ¬∑ Admin</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root {
  --tg-bg: #17212b;
  --tg-surface: #232e3c;
  --tg-surface2: #1c2733;
  --tg-border: rgba(255,255,255,0.08);
  --tg-blue: #2b9af3;
  --tg-blue2: #5ac8fa;
  --tg-green: #4cd964;
  --tg-red: #ff3b30;
  --tg-yellow: #ffd60a;
  --tg-purple: #bf5af2;
  --tg-orange: #ff9f0a;
  --text: #e8eaed;
  --text2: #8a9bb0;
  --text3: #617080;
  --bubble-out: #2b5278;
  --bubble-in: #232e3c;
  --font: 'Inter', -apple-system, sans-serif;
}
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%}
body{font-family:var(--font);background:var(--tg-bg);color:var(--text);display:flex;height:100vh;overflow:hidden;font-size:14px}

#login-screen{position:fixed;inset:0;background:var(--tg-bg);display:flex;align-items:center;justify-content:center;z-index:1000}
.login-wrap{width:320px;text-align:center}
.login-icon{font-size:64px;margin-bottom:16px}
.login-wrap h1{font-size:22px;font-weight:700;margin-bottom:6px}
.login-wrap p{color:var(--text2);font-size:14px;margin-bottom:28px}
.tg-input{width:100%;padding:13px 16px;background:var(--tg-surface);border:1.5px solid var(--tg-border);border-radius:12px;color:var(--text);font-family:var(--font);font-size:15px;outline:none;margin-bottom:12px;transition:border-color .2s}
.tg-input:focus{border-color:var(--tg-blue)}
.tg-btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;padding:10px 16px;border-radius:10px;border:none;font-family:var(--font);font-weight:600;font-size:13px;cursor:pointer;transition:all .15s;text-decoration:none;white-space:nowrap}
.tg-btn-primary{background:var(--tg-blue);color:#fff;width:100%;font-size:15px;padding:13px}
.tg-btn-primary:hover{background:#2487db}
.tg-btn-ghost{background:rgba(255,255,255,0.07);color:var(--text)}
.tg-btn-ghost:hover{background:rgba(255,255,255,0.12)}
.tg-btn-danger{background:rgba(255,59,48,.15);color:var(--tg-red)}
.tg-btn-danger:hover{background:rgba(255,59,48,.25)}
.tg-btn-success{background:rgba(76,217,100,.15);color:var(--tg-green)}
.tg-btn-success:hover{background:rgba(76,217,100,.25)}
.tg-btn-sm{padding:5px 10px;font-size:12px;border-radius:8px}
.login-err{color:var(--tg-red);font-size:13px;margin-top:10px;display:none}

#sidebar{width:240px;min-width:240px;background:var(--tg-surface2);border-right:1px solid var(--tg-border);display:flex;flex-direction:column}
.sidebar-header{padding:18px 16px 14px;border-bottom:1px solid var(--tg-border)}
.sidebar-logo{display:flex;align-items:center;gap:10px}
.sidebar-logo-icon{width:38px;height:38px;border-radius:50%;background:var(--tg-blue);display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0}
.sidebar-logo-text h2{font-size:16px;font-weight:700}
.sidebar-logo-text span{font-size:12px;color:var(--text2)}
nav{flex:1;overflow-y:auto;padding:6px 0}
nav a{display:flex;align-items:center;gap:12px;padding:11px 16px;color:var(--text2);text-decoration:none;font-size:14px;font-weight:500;transition:all .15s;cursor:pointer;position:relative}
nav a:hover{color:var(--text);background:rgba(255,255,255,0.04)}
nav a.active{color:var(--tg-blue);background:rgba(43,154,243,.1)}
nav a.active::before{content:'';position:absolute;left:0;top:4px;bottom:4px;width:3px;background:var(--tg-blue);border-radius:0 2px 2px 0}
.nav-icon{font-size:18px;width:24px;text-align:center;flex-shrink:0}
.nav-badge{margin-left:auto;background:var(--tg-red);color:#fff;font-size:11px;font-weight:700;min-width:18px;height:18px;border-radius:9px;display:flex;align-items:center;justify-content:center;padding:0 5px}
.sidebar-footer{padding:12px 16px;border-top:1px solid var(--tg-border)}
.live-pill{display:flex;align-items:center;gap:6px;background:rgba(76,217,100,.1);border:1px solid rgba(76,217,100,.2);border-radius:20px;padding:7px 12px;font-size:12px;flex-wrap:wrap}
.live-dot{width:7px;height:7px;border-radius:50%;background:var(--tg-green);flex-shrink:0;animation:pulse 1.5s infinite}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.5;transform:scale(.8)}}
.live-pill span{color:var(--text2)}
.live-pill b{color:var(--text)}

#main{flex:1;overflow-y:auto;background:var(--tg-bg)}
.page{display:none;padding:22px}
.page.active{display:block}
.page-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
.page-header h2{font-size:20px;font-weight:700}

.stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:18px}
.stat-card{background:var(--tg-surface);border-radius:12px;padding:16px;border:1px solid var(--tg-border)}
.stat-icon{font-size:22px;margin-bottom:10px}
.stat-value{font-size:28px;font-weight:700;line-height:1;margin-bottom:4px}
.stat-label{font-size:12px;color:var(--text2)}
.stat-sub{font-size:11px;color:var(--text3);margin-top:4px}

.charts-row{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:18px}
.chart-card{background:var(--tg-surface);border-radius:12px;padding:18px;border:1px solid var(--tg-border)}
.chart-card h3{font-size:12px;font-weight:600;color:var(--text3);margin-bottom:12px;text-transform:uppercase;letter-spacing:.5px}

.table-card{background:var(--tg-surface);border-radius:12px;border:1px solid var(--tg-border);overflow:hidden;margin-bottom:16px}
.table-toolbar{display:flex;align-items:center;gap:10px;padding:14px 16px;border-bottom:1px solid var(--tg-border);flex-wrap:wrap}
.table-toolbar h3{font-size:15px;font-weight:600;flex:1}
.tg-select{padding:7px 10px;background:rgba(255,255,255,.06);border:1px solid var(--tg-border);border-radius:8px;color:var(--text);font-size:13px;outline:none;cursor:pointer;font-family:var(--font)}
.tg-search{padding:7px 12px;background:rgba(255,255,255,.06);border:1px solid var(--tg-border);border-radius:8px;color:var(--text);font-size:13px;outline:none;width:180px;font-family:var(--font)}
.tg-search:focus,.tg-select:focus{border-color:var(--tg-blue)}
.tg-search::placeholder{color:var(--text3)}
table{width:100%;border-collapse:collapse}
th{padding:9px 14px;text-align:left;color:var(--text3);font-size:11px;text-transform:uppercase;letter-spacing:.4px;border-bottom:1px solid var(--tg-border);font-weight:600}
td{padding:10px 14px;border-bottom:1px solid rgba(255,255,255,.04);font-size:13px}
tr:last-child td{border-bottom:none}
tr:hover td{background:rgba(255,255,255,.02)}
.pagination{display:flex;align-items:center;gap:8px;padding:11px 16px;border-top:1px solid var(--tg-border)}
.pagination span{font-size:12px;color:var(--text2);flex:1;text-align:center}

.badge{display:inline-flex;align-items:center;padding:3px 8px;border-radius:20px;font-size:11px;font-weight:600;white-space:nowrap}
.badge-free{background:rgba(138,155,176,.15);color:var(--text2)}
.badge-basic{background:rgba(43,154,243,.15);color:var(--tg-blue)}
.badge-pro{background:rgba(255,159,10,.15);color:var(--tg-orange)}
.badge-vip{background:rgba(191,90,242,.15);color:var(--tg-purple)}
.badge-active{background:rgba(76,217,100,.15);color:var(--tg-green)}
.badge-ended{background:rgba(138,155,176,.1);color:var(--text3)}
.badge-pending{background:rgba(255,214,10,.15);color:var(--tg-yellow)}
.badge-confirmed{background:rgba(76,217,100,.15);color:var(--tg-green)}
.badge-banned{background:rgba(255,59,48,.15);color:var(--tg-red)}

.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:500;backdrop-filter:blur(6px)}
.modal{background:var(--tg-surface);border:1px solid var(--tg-border);border-radius:16px;padding:0;width:540px;max-width:95vw;max-height:90vh;overflow:hidden;display:flex;flex-direction:column;box-shadow:0 20px 60px rgba(0,0,0,.5)}
.modal-header{padding:16px 20px;border-bottom:1px solid var(--tg-border);display:flex;align-items:center;gap:10px}
.modal-header h3{font-size:16px;font-weight:700;flex:1}
.modal-close{background:rgba(255,255,255,.07);border:none;color:var(--text2);width:28px;height:28px;border-radius:50%;cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center;transition:all .15s}
.modal-close:hover{background:rgba(255,255,255,.12);color:var(--text)}
.modal-body{padding:20px;overflow-y:auto;flex:1}
.modal-footer{padding:12px 20px;border-top:1px solid var(--tg-border);display:flex;gap:8px;justify-content:flex-end}
.modal label{display:block;font-size:12px;color:var(--text2);font-weight:600;margin-bottom:5px}
.modal .tg-input,.modal .tg-select{margin-bottom:14px}
.modal textarea{width:100%;padding:10px 14px;background:rgba(255,255,255,.06);border:1.5px solid var(--tg-border);border-radius:10px;color:var(--text);font-family:var(--font);font-size:13px;outline:none;margin-bottom:14px;resize:vertical;min-height:100px}
.modal textarea:focus{border-color:var(--tg-blue)}

/* Chat viewer */
.chat-viewer{display:flex;flex-direction:column;gap:6px;max-height:55vh;overflow-y:auto;padding:4px 0}
.msg{max-width:82%;display:flex;flex-direction:column}
.msg.out{align-self:flex-end;align-items:flex-end}
.msg.in{align-self:flex-start;align-items:flex-start}
.msg-bubble{padding:8px 12px;border-radius:14px;font-size:13px;line-height:1.5;word-break:break-word}
.msg.in .msg-bubble{background:var(--bubble-in);border-bottom-left-radius:4px;border:1px solid var(--tg-border)}
.msg.out .msg-bubble{background:var(--bubble-out);border-bottom-right-radius:4px}
.msg-meta{font-size:11px;color:var(--text3);margin-top:3px;padding:0 2px}
.msg-sender{font-size:11px;font-weight:600;margin-bottom:2px;padding:0 2px}
.msg-photo img{max-width:220px;max-height:200px;border-radius:10px;display:block;cursor:pointer}
.msg-audio-player{display:flex;align-items:center;gap:10px;min-width:200px}
.play-btn{width:36px;height:36px;border-radius:50%;background:var(--tg-blue);border:none;color:white;font-size:13px;cursor:pointer;flex-shrink:0;display:flex;align-items:center;justify-content:center;transition:background .15s}
.play-btn:hover{background:#2487db}
.audio-info{flex:1;min-width:0}
.audio-label{font-size:12px;font-weight:600}
.audio-wave{display:flex;align-items:center;gap:1.5px;height:20px;margin-top:4px}
.audio-wave span{display:block;width:2px;border-radius:1px;background:var(--tg-blue2);opacity:.5}
.audio-duration{font-size:11px;color:var(--text3);margin-top:2px}
.msg-file-card{display:flex;align-items:center;gap:10px;background:rgba(255,255,255,.05);border-radius:10px;padding:10px 14px;min-width:180px}
.file-type-icon{width:36px;height:36px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0;background:rgba(43,154,243,.15)}
.file-info{flex:1;min-width:0}
.file-name{font-size:13px;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.file-size{font-size:11px;color:var(--text3);margin-top:2px}
.vnote-wrap{width:140px;height:140px;position:relative}
.vnote-wrap video{width:100%;height:100%;border-radius:50%;object-fit:cover;cursor:pointer}
.media-loading{display:flex;align-items:center;gap:8px;padding:8px;color:var(--text3);font-size:12px}
.spinner{width:16px;height:16px;border:2px solid var(--tg-border);border-top-color:var(--tg-blue);border-radius:50%;animation:spin .6s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

.rt-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:18px}
.rt-card{background:var(--tg-surface);border-radius:12px;padding:20px;text-align:center;border:1px solid var(--tg-border)}
.rt-value{font-size:38px;font-weight:700}
.rt-label{font-size:12px;color:var(--text2);margin-top:6px}

.bc-card{background:var(--tg-surface);border-radius:12px;border:1px solid var(--tg-border);padding:20px;margin-bottom:16px}
.bc-card h3{font-size:15px;font-weight:600;margin-bottom:16px}
.bc-card label{display:block;font-size:12px;color:var(--text2);font-weight:600;margin-bottom:5px}
.bc-card .tg-select{margin-bottom:14px;width:100%}
.bc-card textarea{width:100%;padding:12px 14px;background:rgba(255,255,255,.06);border:1.5px solid var(--tg-border);border-radius:10px;color:var(--text);font-family:var(--font);font-size:13px;outline:none;margin-bottom:14px;resize:vertical;min-height:130px;line-height:1.5}
.bc-card textarea:focus{border-color:var(--tg-blue)}
.bc-result{margin-top:12px;font-size:14px;color:var(--tg-green);font-weight:500}
.bc-result.err{color:var(--tg-red)}

#toast{position:fixed;bottom:20px;right:20px;padding:11px 16px;border-radius:10px;font-size:13px;font-weight:600;z-index:9999;transform:translateY(80px);opacity:0;transition:all .25s cubic-bezier(.34,1.56,.64,1);background:var(--tg-surface);border:1px solid var(--tg-border);box-shadow:0 8px 24px rgba(0,0,0,.4);display:flex;align-items:center;gap:8px}
#toast.show{transform:translateY(0);opacity:1}
#toast.ok::before{content:'‚úì';color:var(--tg-green);font-size:15px}
#toast.err::before{content:'‚úï';color:var(--tg-red);font-size:15px}

::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:rgba(255,255,255,.1);border-radius:3px}
::-webkit-scrollbar-thumb:hover{background:rgba(255,255,255,.18)}

#img-viewer{position:fixed;inset:0;background:rgba(0,0,0,.92);z-index:9000;display:none;align-items:center;justify-content:center;cursor:zoom-out}
#img-viewer img{max-width:90vw;max-height:90vh;border-radius:4px}
#img-viewer.open{display:flex}

@media(max-width:900px){
  .stats-grid{grid-template-columns:repeat(2,1fr)}
  .charts-row{grid-template-columns:1fr}
  .rt-grid{grid-template-columns:repeat(2,1fr)}
}
</style>
</head>
<body>

<div id="img-viewer" onclick="this.classList.remove('open')">
  <img id="img-viewer-src" src="" alt="">
</div>

<!-- Login -->
<div id="login-screen">
  <div class="login-wrap">
    <div class="login-icon">üé≠</div>
    <h1>Anonka Admin</h1>
    <p>–í–≤–µ–¥–∏ –ø–∞—Ä–æ–ª—å –¥–ª—è –≤—Ö–æ–¥–∞</p>
    <input class="tg-input" type="password" id="pw-input" placeholder="–ü–∞—Ä–æ–ª—å" onkeydown="if(event.key==='Enter')doLogin()">
    <button class="tg-btn tg-btn-primary" onclick="doLogin()">–í–æ–π—Ç–∏ ‚Üí</button>
    <div class="login-err" id="login-err">–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å</div>
  </div>
</div>

<!-- Sidebar -->
<div id="sidebar" style="display:none">
  <div class="sidebar-header">
    <div class="sidebar-logo">
      <div class="sidebar-logo-icon">üé≠</div>
      <div class="sidebar-logo-text">
        <h2>Anonka</h2>
        <span>–ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</span>
      </div>
    </div>
  </div>
  <nav>
    <a class="active" data-page="dashboard"><span class="nav-icon">üìä</span> –î–∞—à–±–æ—Ä–¥</a>
    <a data-page="realtime"><span class="nav-icon">üü¢</span> –û–Ω–ª–∞–π–Ω</a>
    <a data-page="users"><span class="nav-icon">üë•</span> –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</a>
    <a data-page="chats"><span class="nav-icon">üí¨</span> –ß–∞—Ç—ã</a>
    <a data-page="reports"><span class="nav-icon">‚ö†Ô∏è</span> –ñ–∞–ª–æ–±—ã <span class="nav-badge" id="nav-reports-badge" style="display:none">0</span></a>
    <a data-page="payments"><span class="nav-icon">üí≥</span> –ü–ª–∞—Ç–µ–∂–∏</a>
    <a data-page="broadcast"><span class="nav-icon">üì¢</span> –†–∞—Å—Å—ã–ª–∫–∞</a>
    <a data-page="topics"><span class="nav-icon">üî•</span> –¢–µ–º—ã</a>
    <a data-page="promos"><span class="nav-icon">üéü</span> –ü—Ä–æ–º–æ–∫–æ–¥—ã</a>
  </nav>
  <div class="sidebar-footer">
    <div class="live-pill">
      <div class="live-dot"></div>
      <span><b id="sb-online">0</b> –æ–Ω–ª–∞–π–Ω</span>
      <span>¬∑</span>
      <span><b id="sb-queue">0</b> –æ—á–µ—Ä–µ–¥—å</span>
    </div>
  </div>
</div>

<!-- Main -->
<div id="main" style="display:none">

  <!-- Dashboard -->
  <div id="page-dashboard" class="page active">
    <div class="page-header">
      <h2>üìä –î–∞—à–±–æ—Ä–¥</h2>
      <button class="tg-btn tg-btn-ghost" onclick="loadDashboard()">‚Üª –û–±–Ω–æ–≤–∏—Ç—å</button>
    </div>
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon">üë•</div>
        <div class="stat-value" id="s-total" style="color:var(--tg-blue)">‚Äî</div>
        <div class="stat-label">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
        <div class="stat-sub" id="s-today-users"></div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">üü¢</div>
        <div class="stat-value" id="s-online" style="color:var(--tg-green)">‚Äî</div>
        <div class="stat-label">–û–Ω–ª–∞–π–Ω —Å–µ–π—á–∞—Å</div>
        <div class="stat-sub" id="s-active-today"></div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">üí¨</div>
        <div class="stat-value" id="s-chats" style="color:var(--tg-orange)">‚Äî</div>
        <div class="stat-label">–î–∏–∞–ª–æ–≥–æ–≤</div>
        <div class="stat-sub" id="s-chats-today"></div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">‚≠ê</div>
        <div class="stat-value" id="s-premium" style="color:var(--tg-yellow)">‚Äî</div>
        <div class="stat-label">Premium</div>
        <div class="stat-sub">‚≠ê <span id="s-stars">0</span> ¬∑ üíé <span id="s-ton">0</span></div>
      </div>
    </div>
    <div class="charts-row">
      <div class="chart-card"><h3>–ù–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ (7 –¥–Ω–µ–π)</h3><canvas id="chart-users" height="140"></canvas></div>
      <div class="chart-card"><h3>–î–∏–∞–ª–æ–≥–∏ (7 –¥–Ω–µ–π)</h3><canvas id="chart-chats" height="140"></canvas></div>
    </div>
    <div class="table-card">
      <div class="table-toolbar"><h3>‚ö†Ô∏è –ñ–∞–ª–æ–±—ã –Ω–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏</h3><span id="s-reports-count" class="badge badge-pending">0</span></div>
      <table><thead><tr><th>#</th><th>–ñ–∞–ª–æ–±—â–∏–∫</th><th>–ù–∞ –∫–æ–≥–æ</th><th>–ü—Ä–∏—á–∏–Ω–∞</th><th>–î–∞—Ç–∞</th><th>–î–µ–π—Å—Ç–≤–∏–µ</th></tr></thead>
      <tbody id="dash-reports-body"></tbody></table>
    </div>
  </div>

  <!-- Realtime -->
  <div id="page-realtime" class="page">
    <div class="page-header">
      <h2>üü¢ –û–Ω–ª–∞–π–Ω</h2>
      <button class="tg-btn tg-btn-ghost" onclick="loadRealtime()">‚Üª –û–±–Ω–æ–≤–∏—Ç—å</button>
    </div>
    <div class="rt-grid">
      <div class="rt-card"><div class="rt-value" id="rt-online" style="color:var(--tg-green)">0</div><div class="rt-label">üü¢ –û–Ω–ª–∞–π–Ω</div></div>
      <div class="rt-card"><div class="rt-value" id="rt-chats" style="color:var(--tg-blue)">0</div><div class="rt-label">üí¨ –ê–∫—Ç–∏–≤–Ω—ã—Ö —á–∞—Ç–æ–≤</div></div>
      <div class="rt-card"><div class="rt-value" id="rt-queue" style="color:var(--tg-yellow)">0</div><div class="rt-label">‚è≥ –í –æ—á–µ—Ä–µ–¥–∏</div></div>
    </div>
    <div class="table-card">
      <div class="table-toolbar"><h3>–ê–∫—Ç–∏–≤–Ω—ã–µ —á–∞—Ç—ã</h3></div>
      <table><thead><tr><th>#</th><th>–£—á–∞—Å—Ç–Ω–∏–∫ A</th><th>–£—á–∞—Å—Ç–Ω–∏–∫ B</th><th>–ù–∞—á–∞–ª–æ</th><th></th></tr></thead>
      <tbody id="rt-live-body"></tbody></table>
    </div>
  </div>

  <!-- Users -->
  <div id="page-users" class="page">
    <div class="page-header"><h2>üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h2></div>
    <div class="table-card">
      <div class="table-toolbar">
        <h3>–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h3>
        <input type="text" class="tg-search" placeholder="üîç –ü–æ–∏—Å–∫..." id="users-search" oninput="loadUsers(1)">
        <select class="tg-select" id="users-filter" onchange="loadUsers(1)">
          <option value="all">–í—Å–µ</option><option value="basic">Basic</option>
          <option value="pro">Pro</option><option value="vip">VIP</option>
          <option value="banned">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ</option>
        </select>
        <button class="tg-btn tg-btn-primary tg-btn-sm" onclick="openGrantModal()">üëë –í—ã–¥–∞—Ç—å Premium</button>
      </div>
      <table>
        <thead><tr><th>ID</th><th>Username</th><th>–ò–º—è</th><th>–¢–∞—Ä–∏—Ñ</th><th>–†–µ–π—Ç–∏–Ω–≥</th><th>–î–∏–∞–ª–æ–≥–æ–≤</th><th>XP</th><th>–î–∞—Ç–∞</th><th></th></tr></thead>
        <tbody id="users-body"></tbody>
      </table>
      <div class="pagination">
        <button class="tg-btn tg-btn-ghost tg-btn-sm" id="users-prev" onclick="usersPage--;loadUsers(usersPage)">‚Üê –ù–∞–∑–∞–¥</button>
        <span id="users-pinfo">–°—Ç—Ä–∞–Ω–∏—Ü–∞ 1</span>
        <button class="tg-btn tg-btn-ghost tg-btn-sm" id="users-next" onclick="usersPage++;loadUsers(usersPage)">–í–ø–µ—Ä—ë–¥ ‚Üí</button>
      </div>
    </div>
  </div>

  <!-- Chats -->
  <div id="page-chats" class="page">
    <div class="page-header"><h2>üí¨ –ß–∞—Ç—ã</h2></div>
    <div class="table-card">
      <div class="table-toolbar">
        <h3>–í—Å–µ –¥–∏–∞–ª–æ–≥–∏</h3>
        <select class="tg-select" id="chats-filter" onchange="loadChats(1)">
          <option value="all">–í—Å–µ</option><option value="active">–ê–∫—Ç–∏–≤–Ω—ã–µ</option><option value="ended">–ó–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ</option>
        </select>
      </div>
      <table>
        <thead><tr><th>#</th><th>–£—á–∞—Å—Ç–Ω–∏–∫ A</th><th>–£—á–∞—Å—Ç–Ω–∏–∫ B</th><th>–°–æ–æ–±—â–µ–Ω–∏–π</th><th>–¢–µ–º–∞</th><th>–ù–∞—á–∞–ª–æ</th><th>–°—Ç–∞—Ç—É—Å</th><th></th></tr></thead>
        <tbody id="chats-body"></tbody>
      </table>
      <div class="pagination">
        <button class="tg-btn tg-btn-ghost tg-btn-sm" id="chats-prev" onclick="chatsPage--;loadChats(chatsPage)">‚Üê –ù–∞–∑–∞–¥</button>
        <span id="chats-pinfo">–°—Ç—Ä–∞–Ω–∏—Ü–∞ 1</span>
        <button class="tg-btn tg-btn-ghost tg-btn-sm" id="chats-next" onclick="chatsPage++;loadChats(chatsPage)">–í–ø–µ—Ä—ë–¥ ‚Üí</button>
      </div>
    </div>
  </div>

  <!-- Reports -->
  <div id="page-reports" class="page">
    <div class="page-header"><h2>‚ö†Ô∏è –ñ–∞–ª–æ–±—ã</h2></div>
    <div class="table-card">
      <div class="table-toolbar">
        <h3>–ñ–∞–ª–æ–±—ã</h3>
        <select class="tg-select" id="reports-filter" onchange="loadReports()">
          <option value="pending">–ù–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏</option><option value="reviewed">–†–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–Ω—ã–µ</option>
          <option value="banned">–ó–∞–±–∞–Ω–µ–Ω—ã</option><option value="all">–í—Å–µ</option>
        </select>
      </div>
      <table>
        <thead><tr><th>#</th><th>–ñ–∞–ª–æ–±—â–∏–∫</th><th>–ù–∞ –∫–æ–≥–æ</th><th>–ü—Ä–∏—á–∏–Ω–∞</th><th>–ß–∞—Ç</th><th>–î–∞—Ç–∞</th><th>–°—Ç–∞—Ç—É—Å</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead>
        <tbody id="reports-body"></tbody>
      </table>
    </div>
  </div>

  <!-- Payments -->
  <div id="page-payments" class="page">
    <div class="page-header"><h2>üí≥ –ü–ª–∞—Ç–µ–∂–∏</h2></div>
    <div class="table-card">
      <div class="table-toolbar">
        <h3>–ò—Å—Ç–æ—Ä–∏—è –ø–ª–∞—Ç–µ–∂–µ–π</h3>
        <select class="tg-select" id="pay-filter" onchange="loadPayments()">
          <option value="">–í—Å–µ</option><option value="stars">‚≠ê Stars</option><option value="ton">üíé TON</option>
        </select>
      </div>
      <table>
        <thead><tr><th>#</th><th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th><th>–¢–∞—Ä–∏—Ñ</th><th>–ú–µ—Ç–æ–¥</th><th>–°—É–º–º–∞</th><th>–°—Ç–∞—Ç—É—Å</th><th>–î–∞—Ç–∞</th></tr></thead>
        <tbody id="pay-body"></tbody>
      </table>
    </div>
  </div>

  <!-- Broadcast -->
  <div id="page-broadcast" class="page">
    <div class="page-header"><h2>üì¢ –†–∞—Å—Å—ã–ª–∫–∞</h2></div>
    <div class="bc-card">
      <h3>–ù–æ–≤–∞—è —Ä–∞—Å—Å—ã–ª–∫–∞</h3>
      <label>–ê—É–¥–∏—Ç–æ—Ä–∏—è</label>
      <select class="tg-select" id="bc-audience">
        <option value="all">üë• –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</option>
        <option value="premium">‚≠ê –¢–æ–ª—å–∫–æ Premium</option>
        <option value="free">üÜì –¢–æ–ª—å–∫–æ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ</option>
      </select>
      <label>–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è</label>
      <textarea id="bc-text" placeholder="–¢–µ–∫—Å—Ç —Ä–∞—Å—Å—ã–ª–∫–∏...&#10;Markdown: *–∂–∏—Ä–Ω—ã–π*, _–∫—É—Ä—Å–∏–≤_, `–∫–æ–¥`"></textarea>
      <div style="display:flex;align-items:center;gap:12px">
        <button class="tg-btn tg-btn-primary" style="width:auto;padding:12px 24px" onclick="sendBroadcast()">üì¢ –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É</button>
      </div>
      <div id="bc-result" class="bc-result"></div>
    </div>
  </div>

  <!-- Topics -->
  <div id="page-topics" class="page">
    <div class="page-header"><h2>üî• –ì–æ—Ä—è—á–∏–µ —Ç–µ–º—ã</h2></div>
    <div class="table-card">
      <div class="table-toolbar">
        <h3>–¢–µ–º—ã –¥–Ω—è</h3>
        <button class="tg-btn tg-btn-primary tg-btn-sm" onclick="openTopicModal()">+ –î–æ–±–∞–≤–∏—Ç—å</button>
      </div>
      <table><thead><tr><th>#</th><th>–¢–µ–∫—Å—Ç</th><th>–ê–∫—Ç–∏–≤–Ω–∞</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead>
      <tbody id="topics-body"></tbody></table>
    </div>
  </div>

  <!-- Promos -->
  <div id="page-promos" class="page">
    <div class="page-header"><h2>üéü –ü—Ä–æ–º–æ–∫–æ–¥—ã</h2></div>
    <div class="table-card">
      <div class="table-toolbar">
        <h3>–ü—Ä–æ–º–æ–∫–æ–¥—ã</h3>
        <button class="tg-btn tg-btn-primary tg-btn-sm" onclick="openPromoModal()">+ –°–æ–∑–¥–∞—Ç—å</button>
      </div>
      <table><thead><tr><th>–ö–æ–¥</th><th>–¢–∞—Ä–∏—Ñ</th><th>–î–Ω–µ–π</th><th>–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π</th><th>–ò—Å—Ç–µ–∫–∞–µ—Ç</th></tr></thead>
      <tbody id="promos-body"></tbody></table>
    </div>
  </div>

</div>

<!-- Modal -->
<div id="modal-overlay" class="modal-overlay" style="display:none" onclick="if(event.target===this)closeModal()">
  <div class="modal">
    <div class="modal-header">
      <h3 id="modal-title">‚Äî</h3>
      <button class="modal-close" onclick="closeModal()">‚úï</button>
    </div>
    <div class="modal-body" id="modal-body"></div>
    <div class="modal-footer" id="modal-footer"></div>
  </div>
</div>

<div id="toast"></div>

<script>
// Set your bot token here to enable media loading in chat viewer
// window.BOT_TOKEN = 'YOUR_BOT_TOKEN';
const BOT_TOKEN = window.BOT_TOKEN || '8247032937:AAFr6en--uwW7UOKEk_bbEp5Kewj6cr-nGI';

let _adminPwd='', authed=false, usersPage=1, chatsPage=1, chartU, chartC;

async function doLogin(){
  const val=document.getElementById('pw-input').value;
  if(val.length<4){showLoginErr('–ü–∞—Ä–æ–ª—å —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π');return}
  _adminPwd=val;
  const r=await fetch('/users/ban',{method:'POST',headers:{'Content-Type':'application/json','X-Admin-Password':val},body:JSON.stringify({user_id:0,reason:'__ping__'})});
  if(r.status===401){_adminPwd='';showLoginErr('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å');document.getElementById('pw-input').value='';return}
  authed=true;
  document.getElementById('login-screen').style.display='none';
  document.getElementById('sidebar').style.display='flex';
  document.getElementById('main').style.display='block';
  initApp();
}
function showLoginErr(m){const e=document.getElementById('login-err');e.textContent=m;e.style.display='block'}

function initApp(){
  document.querySelectorAll('nav a').forEach(a=>{
    a.addEventListener('click',()=>{
      document.querySelectorAll('nav a').forEach(x=>x.classList.remove('active'));
      document.querySelectorAll('.page').forEach(x=>x.classList.remove('active'));
      a.classList.add('active');
      document.getElementById('page-'+a.dataset.page).classList.add('active');
      loadPage(a.dataset.page);
    });
  });
  loadDashboard();
  setInterval(loadRealtime,10000);
  setInterval(updateSidebar,5000);
  updateSidebar();
}
function loadPage(p){({dashboard:loadDashboard,realtime:loadRealtime,users:()=>loadUsers(1),chats:()=>loadChats(1),reports:loadReports,payments:loadPayments,topics:loadTopics,promos:loadPromos})[p]?.()}

async function api(url,opts={}){
  const h={'Content-Type':'application/json'};
  if(opts.method==='POST')h['X-Admin-Password']=_adminPwd;
  try{const r=await fetch(url,{headers:h,...opts});if(r.status===401){toast('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å',true);return{}}return r.json()}
  catch{toast('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è',true);return{}}
}

function toast(msg,err=false){
  const t=document.getElementById('toast');t.textContent=msg;t.className='show '+(err?'err':'ok');
  clearTimeout(t._t);t._t=setTimeout(()=>{t.className=''},3000);
}
function fmtDate(d){
  if(!d)return'‚Äî';const dt=new Date(d),now=new Date();
  if(now-dt<86400000)return dt.toLocaleTimeString('ru',{hour:'2-digit',minute:'2-digit'});
  return dt.toLocaleDateString('ru',{day:'2-digit',month:'2-digit'})+' '+dt.toLocaleTimeString('ru',{hour:'2-digit',minute:'2-digit'});
}
function planBadge(p){
  if(!p||p==='free')return'<span class="badge badge-free">Free</span>';
  return`<span class="badge badge-${p}">${{basic:'‚ö°',pro:'üî•',vip:'üëë'}[p]||''} ${p.toUpperCase()}</span>`;
}
function esc(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}

/* ‚îÄ Media helpers ‚îÄ */
function randWave(){return Array.from({length:20},(_,i)=>[4,6,8,10,12,14,16,14,12,10,8,10,12,14,10,8,6,10,14,12][i]).map(h=>`<span style="height:${h}px"></span>`).join('')}
let _currentAudio=null;
function toggleAudio(btn,url){
  const aud=btn.parentElement.querySelector('audio')||btn.closest('.msg-audio-player').querySelector('audio');
  if(!aud)return;
  if(_currentAudio&&_currentAudio!==aud){_currentAudio.pause();const pb=document.querySelector(`[data-aud="${_currentAudio.id}"]`);if(pb)pb.textContent='‚ñ∂'}
  if(aud.paused){aud.play();btn.textContent='‚è∏';_currentAudio=aud}else{aud.pause();btn.textContent='‚ñ∂'}
}
function updateDur(fid,aud){
  const el=document.getElementById('dur-'+fid);
  if(!el||isNaN(aud.duration))return;
  const m=Math.floor(aud.duration/60),s=Math.floor(aud.duration%60);
  el.textContent=m+':'+(s<10?'0':'')+s;
}
function viewImage(url){document.getElementById('img-viewer-src').src=url;document.getElementById('img-viewer').classList.add('open')}

async function loadTgMedia(fileId,type,container){
  if(!BOT_TOKEN||!fileId){
    container.innerHTML=`<div class="msg-file-card"><div class="file-type-icon">üìé</div><div class="file-info"><div class="file-name">${type}</div><div class="file-size">–¢–æ–∫–µ–Ω –±–æ—Ç–∞ –Ω–µ –∑–∞–¥–∞–Ω</div></div></div>`;
    return;
  }
  try{
    const r=await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/getFile?file_id=${fileId}`);
    const d=await r.json();
    if(!d.ok)throw new Error();
    const url=`https://api.telegram.org/file/bot${BOT_TOKEN}/${d.result.file_path}`;
    const fid=fileId.slice(-8);
    if(type==='photo'||type==='sticker'){
      container.innerHTML=`<div class="msg-photo"><img src="${url}" onclick="viewImage('${url}')" loading="lazy"></div>`;
    }else if(type==='voice'){
      container.innerHTML=`<div class="msg-audio-player">
        <button class="play-btn" onclick="toggleAudio(this,'${url}')">‚ñ∂</button>
        <div class="audio-info"><div class="audio-label">–ì–æ–ª–æ—Å–æ–≤–æ–µ</div><div class="audio-wave">${randWave()}</div><div class="audio-duration" id="dur-${fid}">0:00</div></div>
        <audio id="aud-${fid}" src="${url}" onloadedmetadata="updateDur('${fid}',this)" onended="this.currentTime=0;this.previousElementSibling.previousElementSibling.previousElementSibling.textContent='‚ñ∂'"></audio>
      </div>`;
    }else if(type==='audio'){
      container.innerHTML=`<div class="msg-audio-player">
        <button class="play-btn" onclick="toggleAudio(this,'${url}')">‚ñ∂</button>
        <div class="audio-info"><div class="audio-label">–ê—É–¥–∏–æ</div><div class="audio-wave">${randWave()}</div></div>
        <audio id="aud-${fid}" src="${url}" onended="this.currentTime=0;this.previousElementSibling.previousElementSibling.textContent='‚ñ∂'"></audio>
      </div>`;
    }else if(type==='video_note'){
      container.innerHTML=`<div class="vnote-wrap"><video src="${url}" loop playsinline onclick="this.paused?this.play():this.pause()"></video></div>`;
    }else if(type==='video'){
      container.innerHTML=`<video src="${url}" controls style="max-width:240px;max-height:180px;border-radius:10px;display:block"></video>`;
    }else if(type==='animation'){
      container.innerHTML=`<img src="${url}" style="max-width:220px;border-radius:10px;display:block">`;
    }else{
      const fname=d.result.file_path.split('/').pop();
      const fsize=d.result.file_size?(d.result.file_size/1024).toFixed(0)+'KB':'';
      container.innerHTML=`<a href="${url}" target="_blank" style="text-decoration:none;color:inherit">
        <div class="msg-file-card"><div class="file-type-icon">üìé</div><div class="file-info"><div class="file-name">${esc(fname)}</div><div class="file-size">${fsize}</div></div></div></a>`;
    }
  }catch{container.innerHTML=`<div class="msg-file-card"><div class="file-type-icon">üìé</div><div class="file-info"><div class="file-name">${type}</div><div class="file-size">–§–∞–π–ª –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω</div></div></div>`}
}

/* ‚îÄ Dashboard ‚îÄ */
async function loadDashboard(){
  const s=await api('/stats');if(!s||s.total_users==null)return;
  document.getElementById('s-total').textContent=s.total_users;
  document.getElementById('s-today-users').textContent=`+${s.active_today||0} —Å–µ–≥–æ–¥–Ω—è`;
  document.getElementById('s-online').textContent=s.online_now;
  document.getElementById('s-active-today').textContent=`${s.active_today} –∞–∫—Ç–∏–≤–Ω—ã —Å–µ–≥–æ–¥–Ω—è`;
  document.getElementById('s-chats').textContent=s.total_chats;
  document.getElementById('s-chats-today').textContent=`${s.chats_today} —Å–µ–≥–æ–¥–Ω—è`;
  document.getElementById('s-premium').textContent=s.premium_users;
  document.getElementById('s-stars').textContent=s.payments_stars;
  document.getElementById('s-ton').textContent=s.payments_ton;
  const rc=s.pending_reports||0;
  document.getElementById('s-reports-count').textContent=rc;
  const nb=document.getElementById('nav-reports-badge');
  nb.textContent=rc;nb.style.display=rc>0?'':'none';
  const cfg=(labels,data,color)=>({type:'line',data:{labels,datasets:[{data,borderColor:color,backgroundColor:color+'18',fill:true,tension:.4,pointRadius:3,pointBackgroundColor:color,borderWidth:2}]},options:{plugins:{legend:{display:false}},scales:{x:{grid:{color:'rgba(255,255,255,.05)'},ticks:{color:'#617080',font:{size:11}}},y:{grid:{color:'rgba(255,255,255,.05)'},ticks:{color:'#617080',font:{size:11},stepSize:1}}}}});
  if(chartU)chartU.destroy();if(chartC)chartC.destroy();
  chartU=new Chart(document.getElementById('chart-users'),cfg((s.daily_users||[]).map(x=>x.day.slice(5)),(s.daily_users||[]).map(x=>x.count),'#2b9af3'));
  chartC=new Chart(document.getElementById('chart-chats'),cfg((s.daily_chats||[]).map(x=>x.day.slice(5)),(s.daily_chats||[]).map(x=>x.count),'#ff9f0a'));
  const rData=await api('/reports?status=pending');const reports=rData.reports||[];
  document.getElementById('dash-reports-body').innerHTML=reports.length
    ?reports.slice(0,5).map(r=>`<tr><td style="color:var(--text3)">${r.id}</td><td>@${esc(r.reporter_name||r.reporter_id)}</td><td>@${esc(r.reported_name||r.reported_id)}</td><td style="color:var(--text2)">${esc(r.reason)}</td><td style="font-size:12px;color:var(--text3)">${fmtDate(r.created_at)}</td><td><button class="tg-btn tg-btn-danger tg-btn-sm" onclick="banUser(${r.reported_id})">–ë–∞–Ω</button><button class="tg-btn tg-btn-ghost tg-btn-sm" onclick="dismissReport(${r.id})">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button></td></tr>`).join('')
    :'<tr><td colspan="6" style="text-align:center;color:var(--text3);padding:30px">–ñ–∞–ª–æ–± –Ω–µ—Ç üéâ</td></tr>';
}

/* ‚îÄ Realtime ‚îÄ */
async function loadRealtime(){
  const d=await api('/realtime');if(!d||d.online==null)return;
  document.getElementById('rt-online').textContent=d.online;
  document.getElementById('rt-chats').textContent=d.active_chats;
  document.getElementById('rt-queue').textContent=d.queue;
  updateSidebarData(d.online,d.queue);
  document.getElementById('rt-live-body').innerHTML=d.live&&d.live.length
    ?d.live.map(s=>`<tr><td style="color:var(--text3)">${s.id}</td><td>${s.user_a}</td><td>${s.user_b}</td><td style="font-size:12px;color:var(--text3)">${fmtDate(s.started_at)}</td><td><button class="tg-btn tg-btn-ghost tg-btn-sm" onclick="viewChat(${s.id})">üëÅ –°–º–æ—Ç—Ä–µ—Ç—å</button></td></tr>`).join('')
    :'<tr><td colspan="5" style="text-align:center;color:var(--text3);padding:24px">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —á–∞—Ç–æ–≤</td></tr>';
}
async function updateSidebar(){const d=await api('/realtime');if(d&&d.online!=null)updateSidebarData(d.online,d.queue)}
function updateSidebarData(o,q){document.getElementById('sb-online').textContent=o;document.getElementById('sb-queue').textContent=q}

/* ‚îÄ Users ‚îÄ */
async function loadUsers(page=1){
  usersPage=page;
  const search=document.getElementById('users-search').value,filter=document.getElementById('users-filter').value;
  const d=await api(`/users?page=${page}&search=${encodeURIComponent(search)}&filter=${filter}`);
  const users=d.users||[];
  document.getElementById('users-body').innerHTML=users.length
    ?users.map(u=>`<tr>
      <td style="color:var(--text3);font-size:12px">${u.id}</td>
      <td>${u.username?`<span style="color:var(--tg-blue)">@${esc(u.username)}</span>`:'‚Äî'}</td>
      <td>${esc(u.first_name||'‚Äî')}</td>
      <td>${planBadge(u.premium_plan)}${u.is_banned?'<span class="badge badge-banned" style="margin-left:4px">–ë–ê–ù</span>':''}</td>
      <td>‚≠ê ${(u.rating||5).toFixed(1)}</td><td>${u.total_chats||0}</td>
      <td style="color:var(--tg-purple)">${u.xp||0}</td>
      <td style="font-size:12px;color:var(--text3)">${fmtDate(u.created_at)}</td>
      <td style="white-space:nowrap">${!u.is_banned?`<button class="tg-btn tg-btn-danger tg-btn-sm" onclick="banUser(${u.id})">–ë–∞–Ω</button>`:`<button class="tg-btn tg-btn-success tg-btn-sm" onclick="unbanUser(${u.id})">–†–∞–∑–±–∞–Ω</button>`}
      <button class="tg-btn tg-btn-ghost tg-btn-sm" onclick="viewUserChats(${u.id})">üí¨</button></td>
    </tr>`).join('')
    :'<tr><td colspan="9" style="text-align:center;color:var(--text3);padding:30px">–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</td></tr>';
  document.getElementById('users-pinfo').textContent=`–°—Ç—Ä. ${page} ¬∑ –≤—Å–µ–≥–æ ${d.total||0}`;
  document.getElementById('users-prev').disabled=page<=1;
  document.getElementById('users-next').disabled=users.length<50;
}

/* ‚îÄ Chats ‚îÄ */
async function loadChats(page=1){
  chatsPage=page;
  const filter=document.getElementById('chats-filter').value;
  const d=await api(`/chats?page=${page}&filter=${filter}`);
  const sessions=d.sessions||[];
  document.getElementById('chats-body').innerHTML=sessions.length
    ?sessions.map(s=>`<tr>
      <td style="color:var(--text3)">${s.id}</td>
      <td>${s.username_a?`<span style="color:var(--tg-blue)">@${esc(s.username_a)}</span>`:s.user_a}</td>
      <td>${s.username_b?`<span style="color:var(--tg-blue)">@${esc(s.username_b)}</span>`:s.user_b}</td>
      <td>${s.messages_count||0}</td>
      <td style="max-width:130px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:var(--text2)">${esc(s.topic||'‚Äî')}</td>
      <td style="font-size:12px;color:var(--text3)">${fmtDate(s.started_at)}</td>
      <td><span class="badge badge-${s.status}">${s.status==='active'?'–ê–∫—Ç–∏–≤–µ–Ω':'–ó–∞–≤–µ—Ä—à—ë–Ω'}</span></td>
      <td><button class="tg-btn tg-btn-ghost tg-btn-sm" onclick="viewChat(${s.id})">üëÅ –°–º–æ—Ç—Ä–µ—Ç—å</button></td>
    </tr>`).join('')
    :'<tr><td colspan="8" style="text-align:center;color:var(--text3);padding:30px">–ù–µ—Ç —á–∞—Ç–æ–≤</td></tr>';
  document.getElementById('chats-pinfo').textContent=`–°—Ç—Ä. ${page} ¬∑ –≤—Å–µ–≥–æ ${d.total||0}`;
  document.getElementById('chats-prev').disabled=page<=1;
  document.getElementById('chats-next').disabled=sessions.length<50;
}

/* ‚îÄ View chat ‚îÄ */
async function viewChat(sessionId){
  openModal('üí¨ –ß–∞—Ç #'+sessionId,'<div class="media-loading"><div class="spinner"></div> –ó–∞–≥—Ä—É–∑–∫–∞...</div>',[{label:'–ó–∞–∫—Ä—ã—Ç—å',cls:'tg-btn-ghost',fn:'closeModal()'}]);
  const d=await api(`/chat_messages?session_id=${sessionId}`);
  const msgs=d.messages||[];
  if(!msgs.length){document.getElementById('modal-body').innerHTML='<p style="color:var(--text3);text-align:center;padding:30px">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</p>';return}
  const firstUser=msgs[0].sender_id;
  let html='<div class="chat-viewer">';
  const mq=[];
  msgs.forEach((m,i)=>{
    const isOut=m.sender_id===firstUser;
    const name=m.username?'@'+esc(m.username):esc(m.first_name||'User');
    const fid=m.file_id||m.file_unique_id;
    let content='';
    if(m.msg_type==='text'){
      content=`<div style="white-space:pre-wrap">${esc(m.text_content||'')}</div>`;
    }else if(['photo','voice','audio','video','video_note','document','animation','sticker'].includes(m.msg_type)){
      const mid=`media-${sessionId}-${i}`;
      content=`<div id="${mid}"><div class="media-loading"><div class="spinner"></div></div></div>`;
      if(m.caption)content+=`<div style="margin-top:5px;font-size:12px;color:var(--text2)">${esc(m.caption)}</div>`;
      mq.push({mid,fid,type:m.msg_type});
    }else{
      content=`<div class="msg-file-card"><div class="file-type-icon">üéÅ</div><div class="file-info"><div class="file-name">${esc(m.msg_type)}</div></div></div>`;
    }
    html+=`<div class="msg ${isOut?'out':'in'}">
      <div class="msg-sender" style="color:${isOut?'var(--tg-blue2)':'var(--tg-green)'}">${name}</div>
      <div class="msg-bubble">${content}</div>
      <div class="msg-meta">${fmtDate(m.sent_at)}</div>
    </div>`;
  });
  html+='</div>';
  document.getElementById('modal-body').innerHTML=html;
  const v=document.querySelector('.chat-viewer');if(v)v.scrollTop=v.scrollHeight;
  mq.forEach(({mid,fid,type})=>{const el=document.getElementById(mid);if(el)loadTgMedia(fid,type,el)});
}

/* ‚îÄ Reports ‚îÄ */
async function loadReports(){
  const status=document.getElementById('reports-filter').value;
  const d=await api(`/reports?status=${status}`);
  document.getElementById('reports-body').innerHTML=(d.reports||[]).length
    ?(d.reports||[]).map(r=>`<tr>
      <td style="color:var(--text3)">${r.id}</td>
      <td>@${esc(r.reporter_name||r.reporter_id)}</td><td>@${esc(r.reported_name||r.reported_id)}</td>
      <td style="color:var(--text2)">${esc(r.reason||'‚Äî')}</td>
      <td><button class="tg-btn tg-btn-ghost tg-btn-sm" onclick="viewChat(${r.session_id})">üëÅ</button></td>
      <td style="font-size:12px;color:var(--text3)">${fmtDate(r.created_at)}</td>
      <td><span class="badge badge-${r.status==='pending'?'pending':'active'}">${esc(r.status)}</span></td>
      <td style="white-space:nowrap"><button class="tg-btn tg-btn-danger tg-btn-sm" onclick="banFromReport(${r.id},${r.reported_id})">–ë–∞–Ω</button>
      <button class="tg-btn tg-btn-ghost tg-btn-sm" onclick="dismissReport(${r.id})">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button></td>
    </tr>`).join('')
    :'<tr><td colspan="8" style="text-align:center;color:var(--text3);padding:30px">–ñ–∞–ª–æ–± –Ω–µ—Ç</td></tr>';
}

/* ‚îÄ Payments ‚îÄ */
async function loadPayments(){
  const prov=document.getElementById('pay-filter').value;
  const d=await api(`/payments${prov?'?provider='+prov:''}`);
  document.getElementById('pay-body').innerHTML=(d.payments||[]).length
    ?(d.payments||[]).map(p=>`<tr>
      <td style="color:var(--text3)">${p.id}</td>
      <td>${p.username?`<span style="color:var(--tg-blue)">@${esc(p.username)}</span>`:p.user_id}</td>
      <td>${planBadge(p.plan)}</td><td>${p.provider==='stars'?'‚≠ê Stars':'üíé TON'}</td>
      <td style="font-weight:600">${p.amount||'‚Äî'}</td>
      <td><span class="badge badge-${p.status==='confirmed'?'confirmed':'pending'}">${p.status}</span></td>
      <td style="font-size:12px;color:var(--text3)">${fmtDate(p.created_at)}</td>
    </tr>`).join('')
    :'<tr><td colspan="7" style="text-align:center;color:var(--text3);padding:30px">–ù–µ—Ç –ø–ª–∞—Ç–µ–∂–µ–π</td></tr>';
}

/* ‚îÄ Topics ‚îÄ */
async function loadTopics(){
  const d=await api('/topics');
  document.getElementById('topics-body').innerHTML=(d.topics||[]).length
    ?(d.topics||[]).map(t=>`<tr>
      <td style="color:var(--text3)">${t.id}</td><td>${esc(t.text)}</td>
      <td>${t.is_active?'<span class="badge badge-active">–î–∞</span>':'<span class="badge badge-ended">–ù–µ—Ç</span>'}</td>
      <td style="white-space:nowrap">
        <button class="tg-btn tg-btn-ghost tg-btn-sm" onclick="toggleTopic(${t.id},${!t.is_active})">${t.is_active?'–í—ã–∫–ª':'–í–∫–ª'}</button>
        <button class="tg-btn tg-btn-danger tg-btn-sm" onclick="deleteTopic(${t.id})">–£–¥–∞–ª–∏—Ç—å</button>
      </td>
    </tr>`).join('')
    :'<tr><td colspan="4" style="text-align:center;color:var(--text3);padding:30px">–¢–µ–º –Ω–µ—Ç</td></tr>';
}

/* ‚îÄ Promos ‚îÄ */
async function loadPromos(){
  const d=await api('/promos');
  document.getElementById('promos-body').innerHTML=(d.promos||[]).length
    ?(d.promos||[]).map(p=>`<tr>
      <td style="font-family:monospace;font-weight:700;color:var(--tg-yellow)">${esc(p.code)}</td>
      <td>${planBadge(p.plan)}</td><td>${p.days}</td><td>${p.uses} / ${p.max_uses}</td>
      <td style="font-size:12px;color:var(--text3)">${fmtDate(p.expires_at)}</td>
    </tr>`).join('')
    :'<tr><td colspan="5" style="text-align:center;color:var(--text3);padding:30px">–ü—Ä–æ–º–æ–∫–æ–¥–æ–≤ –Ω–µ—Ç</td></tr>';
}

/* ‚îÄ Broadcast ‚îÄ */
async function sendBroadcast(){
  const text=document.getElementById('bc-text').value.trim();
  const audience=document.getElementById('bc-audience').value;
  if(!text){toast('–í–≤–µ–¥–∏ —Ç–µ–∫—Å—Ç —Ä–∞—Å—Å—ã–ª–∫–∏',true);return}
  const labels={all:'–í–°–ï–ú –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º',premium:'Premium –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º',free:'–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º'};
  if(!confirm(`‚ö†Ô∏è –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É ${labels[audience]}?\n\n"${text.slice(0,100)}${text.length>100?'...':''}"`))return;
  const resEl=document.getElementById('bc-result');resEl.textContent='‚è≥ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º...';resEl.className='bc-result';
  const d=await api('/broadcast',{method:'POST',body:JSON.stringify({text,audience})});
  if(d.success){resEl.textContent=`‚úÖ –†–∞—Å—Å—ã–ª–∫–∞ –∑–∞–ø—É—â–µ–Ω–∞ –¥–ª—è ${d.total||0} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π`;document.getElementById('bc-text').value='';toast(`–†–∞—Å—Å—ã–ª–∫–∞ –∑–∞–ø—É—â–µ–Ω–∞ (${d.total||0})`)}
  else{resEl.textContent='‚ùå –û—à–∏–±–∫–∞';resEl.className='bc-result err'}
}

/* ‚îÄ Actions ‚îÄ */
async function banUser(id){
  if(!confirm(`–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${id}?`))return;
  await api('/users/ban',{method:'POST',body:JSON.stringify({user_id:id,reason:'–ë–∞–Ω –∏–∑ –ø–∞–Ω–µ–ª–∏'})});
  toast('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω');loadUsers(usersPage);
}
async function unbanUser(id){
  await api('/users/unban',{method:'POST',body:JSON.stringify({user_id:id})});
  toast('–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω');loadUsers(usersPage);
}
async function banFromReport(rId,uid){
  if(!confirm('–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ –∂–∞–ª–æ–±–µ?'))return;
  await api('/users/ban',{method:'POST',body:JSON.stringify({user_id:uid,reason:'–ë–∞–Ω –ø–æ –∂–∞–ª–æ–±–µ'})});
  await api('/reports/dismiss',{method:'POST',body:JSON.stringify({report_id:rId,action:'ban'})});
  toast('–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω, –∂–∞–ª–æ–±–∞ –∑–∞–∫—Ä—ã—Ç–∞');loadReports();
}
async function dismissReport(id){
  await api('/reports/dismiss',{method:'POST',body:JSON.stringify({report_id:id,action:'dismiss'})});
  toast('–ñ–∞–ª–æ–±–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞');loadReports();
}
async function toggleTopic(id,active){await api('/topics/toggle',{method:'POST',body:JSON.stringify({id,active})});loadTopics()}
async function deleteTopic(id){if(!confirm('–£–¥–∞–ª–∏—Ç—å —Ç–µ–º—É?'))return;await api('/topics/delete',{method:'POST',body:JSON.stringify({id})});toast('–¢–µ–º–∞ —É–¥–∞–ª–µ–Ω–∞');loadTopics()}
async function viewUserChats(userId){
  document.querySelector('[data-page="chats"]').click();
  setTimeout(async()=>{
    const d=await api(`/chats?page=1&filter=all&user_id=${userId}`);
    const sessions=d.sessions||[];
    document.getElementById('chats-body').innerHTML=sessions.length
      ?sessions.map(s=>`<tr><td style="color:var(--text3)">${s.id}</td><td>${s.username_a?'@'+esc(s.username_a):s.user_a}</td><td>${s.username_b?'@'+esc(s.username_b):s.user_b}</td><td>${s.messages_count||0}</td><td>${esc(s.topic||'‚Äî')}</td><td style="font-size:12px;color:var(--text3)">${fmtDate(s.started_at)}</td><td><span class="badge badge-${s.status}">${s.status==='active'?'–ê–∫—Ç–∏–≤–µ–Ω':'–ó–∞–≤–µ—Ä—à—ë–Ω'}</span></td><td><button class="tg-btn tg-btn-ghost tg-btn-sm" onclick="viewChat(${s.id})">üëÅ</button></td></tr>`).join('')
      :'<tr><td colspan="8" style="text-align:center;color:var(--text3);padding:30px">–ß–∞—Ç–æ–≤ –Ω–µ—Ç</td></tr>';
  },100);
}

/* ‚îÄ Modal ‚îÄ */
function openModal(title,bodyHtml,footerBtns=[]){
  document.getElementById('modal-title').textContent=title;
  document.getElementById('modal-body').innerHTML=bodyHtml;
  document.getElementById('modal-footer').innerHTML=footerBtns.map(b=>`<button class="tg-btn ${b.cls}" onclick="${b.fn}">${b.label}</button>`).join('');
  document.getElementById('modal-overlay').style.display='flex';
}
function closeModal(){
  document.getElementById('modal-overlay').style.display='none';
  if(_currentAudio){_currentAudio.pause();_currentAudio=null}
}

function openGrantModal(){
  openModal('üëë –í—ã–¥–∞—Ç—å Premium',
    `<label>User ID</label><input class="tg-input" type="number" id="g-uid" placeholder="123456789">
    <label>–¢–∞—Ä–∏—Ñ</label><select class="tg-input tg-select" id="g-plan"><option value="basic">‚ö° –ë–∞–∑–æ–≤—ã–π</option><option value="pro">üî• –ü—Ä–æ</option><option value="vip">üëë VIP</option></select>
    <label>–î–Ω–µ–π</label><input class="tg-input" type="number" id="g-days" value="30">`,
    [{label:'–û—Ç–º–µ–Ω–∞',cls:'tg-btn-ghost',fn:'closeModal()'},{label:'‚úì –í—ã–¥–∞—Ç—å',cls:'tg-btn-primary',fn:'doGrant()'}]);
}
async function doGrant(){
  const uid=parseInt(document.getElementById('g-uid').value),plan=document.getElementById('g-plan').value,days=parseInt(document.getElementById('g-days').value);
  if(!uid||!days){toast('–ó–∞–ø–æ–ª–Ω–∏ –≤—Å–µ –ø–æ–ª—è',true);return}
  await api('/users/grant-premium',{method:'POST',body:JSON.stringify({user_id:uid,plan,days})});
  toast('‚úÖ Premium –≤—ã–¥–∞–Ω!');closeModal();
}

function openTopicModal(){
  openModal('üî• –ù–æ–≤–∞—è —Ç–µ–º–∞',
    `<label>–¢–µ–∫—Å—Ç —Ç–µ–º—ã</label><input class="tg-input" type="text" id="topic-text" placeholder="üí≠ –¢–µ–º–∞ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞...">`,
    [{label:'–û—Ç–º–µ–Ω–∞',cls:'tg-btn-ghost',fn:'closeModal()'},{label:'+ –î–æ–±–∞–≤–∏—Ç—å',cls:'tg-btn-primary',fn:'doAddTopic()'}]);
}
async function doAddTopic(){
  const text=document.getElementById('topic-text').value.trim();if(!text)return;
  await api('/topics/add',{method:'POST',body:JSON.stringify({text})});toast('–¢–µ–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞');closeModal();loadTopics();
}

function openPromoModal(){
  openModal('üéü –°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥',
    `<label>–ö–æ–¥</label><input class="tg-input" type="text" id="promo-code" placeholder="SUMMER2025" style="text-transform:uppercase">
    <label>–¢–∞—Ä–∏—Ñ</label><select class="tg-input tg-select" id="promo-plan"><option value="basic">‚ö° –ë–∞–∑–æ–≤—ã–π</option><option value="pro">üî• –ü—Ä–æ</option><option value="vip">üëë VIP</option></select>
    <label>–î–Ω–µ–π</label><input class="tg-input" type="number" id="promo-days" value="30">
    <label>–ú–∞–∫—Å. –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π</label><input class="tg-input" type="number" id="promo-uses" value="1">`,
    [{label:'–û—Ç–º–µ–Ω–∞',cls:'tg-btn-ghost',fn:'closeModal()'},{label:'+ –°–æ–∑–¥–∞—Ç—å',cls:'tg-btn-primary',fn:'doCreatePromo()'}]);
}
async function doCreatePromo(){
  const code=document.getElementById('promo-code').value.trim().toUpperCase();
  const plan=document.getElementById('promo-plan').value;
  const days=parseInt(document.getElementById('promo-days').value);
  const uses=parseInt(document.getElementById('promo-uses').value);
  if(!code||!days||!uses){toast('–ó–∞–ø–æ–ª–Ω–∏ –≤—Å–µ –ø–æ–ª—è',true);return}
  const d=await api('/promo',{method:'POST',body:JSON.stringify({code,plan,days,max_uses:uses})});
  if(d.success){toast('–ü—Ä–æ–º–æ–∫–æ–¥ —Å–æ–∑–¥–∞–Ω!');closeModal();loadPromos()}else toast('‚ùå –¢–∞–∫–æ–π –∫–æ–¥ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç',true);
}
</script>
</body>
</html>
