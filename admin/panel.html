<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Anonka Admin</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root {
  --bg: #080c10;
  --surface: #0e1318;
  --surface2: #141b22;
  --border: rgba(255,255,255,0.07);
  --accent: #00d4ff;
  --accent2: #7c3aed;
  --green: #00ff88;
  --red: #ff4466;
  --yellow: #ffcc00;
  --text: #e2e8f0;
  --muted: #64748b;
  --font: 'Syne', sans-serif;
  --mono: 'JetBrains Mono', monospace;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
html, body { height: 100%; }
body { font-family: var(--font); background: var(--bg); color: var(--text); display: flex; height: 100vh; overflow: hidden; }

/* Login */
#login-screen {
  position: fixed; inset: 0; background: var(--bg);
  display: flex; align-items: center; justify-content: center;
  z-index: 1000;
}
.login-box {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: 20px; padding: 48px 40px; width: 360px;
  text-align: center;
}
.login-box h1 { font-size: 28px; font-weight: 800; margin-bottom: 8px; }
.login-box p { color: var(--muted); margin-bottom: 32px; font-size: 14px; }
.login-box input {
  width: 100%; padding: 14px 16px; background: var(--surface2);
  border: 1px solid var(--border); border-radius: 10px;
  color: var(--text); font-family: var(--mono); font-size: 16px;
  outline: none; margin-bottom: 16px; letter-spacing: 2px;
}
.login-box input:focus { border-color: var(--accent); }
.login-box button {
  width: 100%; padding: 14px; background: var(--accent);
  color: #000; font-family: var(--font); font-weight: 700;
  font-size: 15px; border: none; border-radius: 10px; cursor: pointer;
  transition: opacity 0.2s;
}
.login-box button:hover { opacity: 0.85; }
.login-error { color: var(--red); font-size: 13px; margin-top: 10px; display: none; }

/* Sidebar */
#sidebar {
  width: 220px; min-width: 220px; background: var(--surface);
  border-right: 1px solid var(--border); display: flex;
  flex-direction: column; padding: 24px 0;
}
.logo { padding: 0 20px 24px; font-size: 20px; font-weight: 800; }
.logo span { color: var(--accent); }
nav a {
  display: flex; align-items: center; gap: 10px;
  padding: 11px 20px; color: var(--muted); text-decoration: none;
  font-size: 14px; font-weight: 600; transition: all 0.15s;
  cursor: pointer; border-left: 3px solid transparent;
}
nav a:hover { color: var(--text); background: rgba(255,255,255,0.03); }
nav a.active { color: var(--accent); border-left-color: var(--accent); background: rgba(0,212,255,0.05); }
.nav-icon { font-size: 18px; width: 22px; }

/* Live badge */
#live-badge {
  margin: 16px 20px 0; padding: 10px 14px;
  background: rgba(0,255,136,0.08); border: 1px solid rgba(0,255,136,0.2);
  border-radius: 10px; font-size: 12px;
}
.live-dot { display: inline-block; width: 7px; height: 7px; border-radius: 50%; background: var(--green); animation: pulse 1.5s infinite; margin-right: 6px; }
@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }

/* Main */
#main { flex: 1; overflow-y: auto; padding: 32px; }
.page { display: none; }
.page.active { display: block; }

/* Header */
.page-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 28px; }
.page-header h2 { font-size: 24px; font-weight: 800; }

/* Stats grid */
.stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 28px; }
.stat-card {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: 14px; padding: 20px; position: relative; overflow: hidden;
}
.stat-card::before {
  content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px;
  background: var(--accent-c, var(--accent));
}
.stat-label { font-size: 12px; color: var(--muted); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 10px; }
.stat-value { font-size: 32px; font-weight: 800; font-family: var(--mono); }
.stat-sub { font-size: 12px; color: var(--muted); margin-top: 4px; }

/* Charts */
.charts-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 28px; }
.chart-card { background: var(--surface); border: 1px solid var(--border); border-radius: 14px; padding: 20px; }
.chart-card h3 { font-size: 14px; font-weight: 700; margin-bottom: 16px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; }

/* Table */
.table-card { background: var(--surface); border: 1px solid var(--border); border-radius: 14px; overflow: hidden; margin-bottom: 20px; }
.table-toolbar { display: flex; align-items: center; gap: 12px; padding: 16px 20px; border-bottom: 1px solid var(--border); flex-wrap: wrap; }
.table-toolbar h3 { font-size: 15px; font-weight: 700; flex: 1; }
.search-input {
  padding: 8px 14px; background: var(--surface2); border: 1px solid var(--border);
  border-radius: 8px; color: var(--text); font-family: var(--font); font-size: 13px;
  outline: none; width: 200px;
}
.search-input:focus { border-color: var(--accent); }
.filter-select {
  padding: 8px 12px; background: var(--surface2); border: 1px solid var(--border);
  border-radius: 8px; color: var(--text); font-size: 13px; outline: none; cursor: pointer;
}
table { width: 100%; border-collapse: collapse; font-size: 13px; }
th { padding: 10px 16px; text-align: left; color: var(--muted); font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid var(--border); }
td { padding: 12px 16px; border-bottom: 1px solid rgba(255,255,255,0.03); }
tr:last-child td { border-bottom: none; }
tr:hover td { background: rgba(255,255,255,0.02); }
.badge { display: inline-block; padding: 3px 8px; border-radius: 6px; font-size: 11px; font-weight: 700; font-family: var(--mono); }
.badge-free    { background: rgba(100,116,139,0.2); color: var(--muted); }
.badge-basic   { background: rgba(0,212,255,0.15); color: var(--accent); }
.badge-pro     { background: rgba(255,100,50,0.15); color: #ff6432; }
.badge-vip     { background: rgba(255,204,0,0.15); color: var(--yellow); }
.badge-active  { background: rgba(0,255,136,0.15); color: var(--green); }
.badge-ended   { background: rgba(100,116,139,0.15); color: var(--muted); }
.badge-pending { background: rgba(255,204,0,0.15); color: var(--yellow); }
.badge-confirmed { background: rgba(0,255,136,0.15); color: var(--green); }
.badge-banned  { background: rgba(255,68,102,0.15); color: var(--red); }
.btn { padding: 6px 12px; border-radius: 7px; border: none; font-family: var(--font); font-weight: 700; font-size: 12px; cursor: pointer; transition: opacity 0.15s; }
.btn:hover { opacity: 0.8; }
.btn-primary { background: var(--accent); color: #000; }
.btn-danger  { background: var(--red); color: #fff; }
.btn-success { background: var(--green); color: #000; }
.btn-ghost   { background: rgba(255,255,255,0.08); color: var(--text); }
.btn-sm { padding: 4px 9px; font-size: 11px; }
.pagination { display: flex; align-items: center; gap: 8px; padding: 14px 20px; }
.pagination span { font-size: 13px; color: var(--muted); }

/* Modal */
.modal-overlay {
  position: fixed; inset: 0; background: rgba(0,0,0,0.7);
  display: flex; align-items: center; justify-content: center;
  z-index: 500; backdrop-filter: blur(4px);
}
.modal {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: 16px; padding: 28px; width: 520px; max-width: 95vw;
  max-height: 85vh; overflow-y: auto;
}
.modal h3 { font-size: 18px; font-weight: 800; margin-bottom: 20px; }
.modal label { display: block; font-size: 12px; color: var(--muted); font-weight: 600; margin-bottom: 6px; text-transform: uppercase; }
.modal input, .modal select, .modal textarea {
  width: 100%; padding: 10px 14px; background: var(--surface2);
  border: 1px solid var(--border); border-radius: 8px;
  color: var(--text); font-family: var(--font); font-size: 14px;
  outline: none; margin-bottom: 16px;
}
.modal textarea { resize: vertical; min-height: 100px; font-family: var(--mono); }
.modal input:focus, .modal select:focus, .modal textarea:focus { border-color: var(--accent); }
.modal-footer { display: flex; gap: 10px; justify-content: flex-end; margin-top: 8px; }
.modal-close { position: absolute; top: 16px; right: 16px; background: none; border: none; color: var(--muted); font-size: 20px; cursor: pointer; }

/* Chat viewer */
.chat-messages { display: flex; flex-direction: column; gap: 10px; padding: 16px; background: var(--surface2); border-radius: 10px; max-height: 500px; overflow-y: auto; }
.msg { max-width: 75%; }
.msg.left { align-self: flex-start; }
.msg.right { align-self: flex-end; }
.msg-bubble {
  padding: 10px 14px; border-radius: 14px; font-size: 13px; line-height: 1.5;
}
.msg.left .msg-bubble  { background: var(--surface); border: 1px solid var(--border); border-bottom-left-radius: 4px; }
.msg.right .msg-bubble { background: rgba(0,212,255,0.1); border: 1px solid rgba(0,212,255,0.2); border-bottom-right-radius: 4px; }
.msg-meta { font-size: 11px; color: var(--muted); margin-top: 4px; font-family: var(--mono); }
.msg-file { display: flex; align-items: center; gap: 8px; font-size: 12px; padding: 8px 12px; background: rgba(255,255,255,0.05); border-radius: 8px; }
.msg-file .file-icon { font-size: 20px; }

/* Realtime section */
.realtime-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 14px; margin-bottom: 20px; }
.rt-card { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 16px; text-align: center; }
.rt-value { font-size: 36px; font-weight: 800; font-family: var(--mono); }
.rt-label { font-size: 12px; color: var(--muted); margin-top: 4px; }

/* Scrollbar */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.2); }

/* Toast */
#toast {
  position: fixed; bottom: 24px; right: 24px;
  padding: 12px 20px; border-radius: 10px; font-size: 14px; font-weight: 600;
  z-index: 9999; transform: translateY(80px); opacity: 0;
  transition: all 0.3s; background: var(--green); color: #000;
}
#toast.show { transform: translateY(0); opacity: 1; }
#toast.error { background: var(--red); color: #fff; }

@media(max-width:900px) {
  .stats-grid { grid-template-columns: repeat(2,1fr); }
  .charts-row { grid-template-columns: 1fr; }
  .realtime-grid { grid-template-columns: repeat(2,1fr); }
}
</style>
</head>
<body>

<!-- Login -->
<div id="login-screen">
  <div class="login-box">
    <h1>üé≠ Anonka</h1>
    <p>–ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</p>
    <input type="password" id="pw-input" placeholder="–ü–∞—Ä–æ–ª—å" onkeydown="if(event.key==='Enter')doLogin()">
    <button onclick="doLogin()">–í–æ–π—Ç–∏</button>
    <div class="login-error" id="login-err">–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å</div>
  </div>
</div>

<!-- Sidebar -->
<div id="sidebar" style="display:none">
  <div class="logo">Anon<span>ka</span></div>
  <nav>
    <a class="active" data-page="dashboard"><span class="nav-icon">üìä</span> –î–∞—à–±–æ—Ä–¥</a>
    <a data-page="realtime"><span class="nav-icon">üî¥</span> –û–Ω–ª–∞–π–Ω</a>
    <a data-page="users"><span class="nav-icon">üë•</span> –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</a>
    <a data-page="chats"><span class="nav-icon">üí¨</span> –ß–∞—Ç—ã</a>
    <a data-page="reports"><span class="nav-icon">‚ö†Ô∏è</span> –ñ–∞–ª–æ–±—ã</a>
    <a data-page="payments"><span class="nav-icon">üí∞</span> –ü–ª–∞—Ç–µ–∂–∏</a>
    <a data-page="broadcast"><span class="nav-icon">üì¢</span> –†–∞—Å—Å—ã–ª–∫–∞</a>
    <a data-page="topics"><span class="nav-icon">üî•</span> –¢–µ–º—ã</a>
    <a data-page="promos"><span class="nav-icon">üéü</span> –ü—Ä–æ–º–æ–∫–æ–¥—ã</a>
  </nav>
  <div id="live-badge">
    <span class="live-dot"></span>
    <span id="sb-online">0</span> –æ–Ω–ª–∞–π–Ω ¬∑ <span id="sb-queue">0</span> –≤ –æ—á–µ—Ä–µ–¥–∏
  </div>
</div>

<!-- Main -->
<div id="main" style="display:none">

  <!-- Dashboard -->
  <div id="page-dashboard" class="page active">
    <div class="page-header">
      <h2>üìä –î–∞—à–±–æ—Ä–¥</h2>
      <button class="btn btn-ghost" onclick="loadDashboard()">‚Üª –û–±–Ω–æ–≤–∏—Ç—å</button>
    </div>
    <div class="stats-grid">
      <div class="stat-card" style="--accent-c:var(--accent)">
        <div class="stat-label">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
        <div class="stat-value" id="s-total">‚Äî</div>
        <div class="stat-sub" id="s-today-users">—Å–µ–≥–æ–¥–Ω—è: ‚Äî</div>
      </div>
      <div class="stat-card" style="--accent-c:var(--green)">
        <div class="stat-label">–û–Ω–ª–∞–π–Ω —Å–µ–π—á–∞—Å</div>
        <div class="stat-value" id="s-online">‚Äî</div>
        <div class="stat-sub" id="s-active-today">–∞–∫—Ç–∏–≤–Ω—ã —Å–µ–≥–æ–¥–Ω—è: ‚Äî</div>
      </div>
      <div class="stat-card" style="--accent-c:#ff6432">
        <div class="stat-label">–î–∏–∞–ª–æ–≥–æ–≤</div>
        <div class="stat-value" id="s-chats">‚Äî</div>
        <div class="stat-sub" id="s-chats-today">—Å–µ–≥–æ–¥–Ω—è: ‚Äî</div>
      </div>
      <div class="stat-card" style="--accent-c:var(--yellow)">
        <div class="stat-label">Premium</div>
        <div class="stat-value" id="s-premium">‚Äî</div>
        <div class="stat-sub">‚≠ê <span id="s-stars">0</span> Stars ¬∑ üíé <span id="s-ton">0</span> TON</div>
      </div>
    </div>
    <div class="charts-row">
      <div class="chart-card">
        <h3>–ù–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ (7 –¥–Ω–µ–π)</h3>
        <canvas id="chart-users" height="160"></canvas>
      </div>
      <div class="chart-card">
        <h3>–î–∏–∞–ª–æ–≥–∏ (7 –¥–Ω–µ–π)</h3>
        <canvas id="chart-chats" height="160"></canvas>
      </div>
    </div>
    <div class="table-card">
      <div class="table-toolbar"><h3>‚ö†Ô∏è –ñ–∞–ª–æ–±—ã –Ω–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏</h3><span id="s-reports-count" class="badge badge-pending">0</span></div>
      <table><thead><tr><th>#</th><th>–ñ–∞–ª–æ–±—â–∏–∫</th><th>–ù–∞ –∫–æ–≥–æ</th><th>–ü—Ä–∏—á–∏–Ω–∞</th><th>–î–∞—Ç–∞</th><th>–î–µ–π—Å—Ç–≤–∏–µ</th></tr></thead>
      <tbody id="dash-reports-body"><tr><td colspan="6" style="text-align:center;color:var(--muted);padding:30px">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr></tbody>
      </table>
    </div>
  </div>

  <!-- Realtime -->
  <div id="page-realtime" class="page">
    <div class="page-header">
      <h2>üî¥ –û–Ω–ª–∞–π–Ω</h2>
      <button class="btn btn-ghost" onclick="loadRealtime()">‚Üª –û–±–Ω–æ–≤–∏—Ç—å</button>
    </div>
    <div class="realtime-grid">
      <div class="rt-card"><div class="rt-value" id="rt-online">0</div><div class="rt-label">üü¢ –û–Ω–ª–∞–π–Ω</div></div>
      <div class="rt-card"><div class="rt-value" id="rt-chats">0</div><div class="rt-label">üí¨ –ê–∫—Ç–∏–≤–Ω—ã—Ö —á–∞—Ç–æ–≤</div></div>
      <div class="rt-card"><div class="rt-value" id="rt-queue">0</div><div class="rt-label">‚è≥ –í –æ—á–µ—Ä–µ–¥–∏</div></div>
    </div>
    <div class="table-card">
      <div class="table-toolbar"><h3>–ê–∫—Ç–∏–≤–Ω—ã–µ —á–∞—Ç—ã</h3></div>
      <table><thead><tr><th>#</th><th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å A</th><th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å B</th><th>–ù–∞—á–∞–ª–æ</th><th>–°–º–æ—Ç—Ä–µ—Ç—å</th></tr></thead>
      <tbody id="rt-live-body"><tr><td colspan="5" style="text-align:center;color:var(--muted);padding:30px">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr></tbody>
      </table>
    </div>
  </div>

  <!-- Users -->
  <div id="page-users" class="page">
    <div class="page-header"><h2>üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h2></div>
    <div class="table-card">
      <div class="table-toolbar">
        <h3>–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h3>
        <input type="text" class="search-input" placeholder="–ü–æ–∏—Å–∫..." id="users-search" oninput="loadUsers(1)">
        <select class="filter-select" id="users-filter" onchange="loadUsers(1)">
          <option value="all">–í—Å–µ</option>
          <option value="basic">Basic</option>
          <option value="pro">Pro</option>
          <option value="vip">VIP</option>
          <option value="banned">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ</option>
        </select>
        <button class="btn btn-primary btn-sm" onclick="openGrantModal()">üëë –í—ã–¥–∞—Ç—å Premium</button>
      </div>
      <table>
        <thead><tr><th>ID</th><th>Username</th><th>–ò–º—è</th><th>–¢–∞—Ä–∏—Ñ</th><th>–†–µ–π—Ç–∏–Ω–≥</th><th>–î–∏–∞–ª–æ–≥–æ–≤</th><th>XP</th><th>–î–∞—Ç–∞</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead>
        <tbody id="users-body"><tr><td colspan="9" style="text-align:center;color:var(--muted);padding:30px">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr></tbody>
      </table>
      <div class="pagination">
        <button class="btn btn-ghost btn-sm" id="users-prev" onclick="usersPage--;loadUsers(usersPage)">‚Üê</button>
        <span id="users-pinfo">–°—Ç—Ä–∞–Ω–∏—Ü–∞ 1</span>
        <button class="btn btn-ghost btn-sm" id="users-next" onclick="usersPage++;loadUsers(usersPage)">‚Üí</button>
      </div>
    </div>
  </div>

  <!-- Chats -->
  <div id="page-chats" class="page">
    <div class="page-header"><h2>üí¨ –ß–∞—Ç—ã</h2></div>
    <div class="table-card">
      <div class="table-toolbar">
        <h3>–í—Å–µ –¥–∏–∞–ª–æ–≥–∏</h3>
        <select class="filter-select" id="chats-filter" onchange="loadChats(1)">
          <option value="all">–í—Å–µ</option>
          <option value="active">–ê–∫—Ç–∏–≤–Ω—ã–µ</option>
          <option value="ended">–ó–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ</option>
        </select>
      </div>
      <table>
        <thead><tr><th>#</th><th>–£—á–∞—Å—Ç–Ω–∏–∫ A</th><th>–£—á–∞—Å—Ç–Ω–∏–∫ B</th><th>–°–æ–æ–±—â–µ–Ω–∏–π</th><th>–¢–µ–º–∞</th><th>–ù–∞—á–∞–ª–æ</th><th>–°—Ç–∞—Ç—É—Å</th><th>–ü—Ä–æ—Å–º–æ—Ç—Ä</th></tr></thead>
        <tbody id="chats-body"><tr><td colspan="8" style="text-align:center;color:var(--muted);padding:30px">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr></tbody>
      </table>
      <div class="pagination">
        <button class="btn btn-ghost btn-sm" id="chats-prev" onclick="chatsPage--;loadChats(chatsPage)">‚Üê</button>
        <span id="chats-pinfo">–°—Ç—Ä–∞–Ω–∏—Ü–∞ 1</span>
        <button class="btn btn-ghost btn-sm" id="chats-next" onclick="chatsPage++;loadChats(chatsPage)">‚Üí</button>
      </div>
    </div>
  </div>

  <!-- Reports -->
  <div id="page-reports" class="page">
    <div class="page-header"><h2>‚ö†Ô∏è –ñ–∞–ª–æ–±—ã</h2></div>
    <div class="table-card">
      <div class="table-toolbar">
        <h3>–ñ–∞–ª–æ–±—ã</h3>
        <select class="filter-select" id="reports-filter" onchange="loadReports()">
          <option value="pending">–ù–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏</option>
          <option value="reviewed">–†–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–Ω—ã–µ</option>
          <option value="banned">–ó–∞–±–∞–Ω–µ–Ω—ã</option>
          <option value="all">–í—Å–µ</option>
        </select>
      </div>
      <table>
        <thead><tr><th>#</th><th>–ñ–∞–ª–æ–±—â–∏–∫</th><th>–ù–∞ –∫–æ–≥–æ</th><th>–ü—Ä–∏—á–∏–Ω–∞</th><th>–ß–∞—Ç</th><th>–î–∞—Ç–∞</th><th>–°—Ç–∞—Ç—É—Å</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead>
        <tbody id="reports-body"><tr><td colspan="8" style="text-align:center;color:var(--muted);padding:30px">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr></tbody>
      </table>
    </div>
  </div>

  <!-- Payments -->
  <div id="page-payments" class="page">
    <div class="page-header"><h2>üí∞ –ü–ª–∞—Ç–µ–∂–∏</h2></div>
    <div class="table-card">
      <div class="table-toolbar">
        <h3>–ò—Å—Ç–æ—Ä–∏—è –ø–ª–∞—Ç–µ–∂–µ–π</h3>
        <select class="filter-select" id="pay-filter" onchange="loadPayments()">
          <option value="">–í—Å–µ</option>
          <option value="stars">Stars</option>
          <option value="ton">TON</option>
        </select>
      </div>
      <table>
        <thead><tr><th>#</th><th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th><th>–¢–∞—Ä–∏—Ñ</th><th>–ú–µ—Ç–æ–¥</th><th>–°—É–º–º–∞</th><th>–°—Ç–∞—Ç—É—Å</th><th>–î–∞—Ç–∞</th></tr></thead>
        <tbody id="pay-body"><tr><td colspan="7" style="text-align:center;color:var(--muted);padding:30px">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr></tbody>
      </table>
    </div>
  </div>

  <!-- Broadcast -->
  <div id="page-broadcast" class="page">
    <div class="page-header"><h2>üì¢ –†–∞—Å—Å—ã–ª–∫–∞</h2></div>
    <div class="table-card" style="padding:24px">
      <h3 style="margin-bottom:20px">–ù–æ–≤–∞—è —Ä–∞—Å—Å—ã–ª–∫–∞</h3>
      <label>–ê—É–¥–∏—Ç–æ—Ä–∏—è</label>
      <select class="filter-select" id="bc-audience" style="width:100%;margin-bottom:16px">
        <option value="all">–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</option>
        <option value="premium">–¢–æ–ª—å–∫–æ Premium</option>
        <option value="free">–¢–æ–ª—å–∫–æ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ</option>
      </select>
      <label>–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è</label>
      <textarea id="bc-text" placeholder="–í–≤–µ–¥–∏ —Ç–µ–∫—Å—Ç —Ä–∞—Å—Å—ã–ª–∫–∏..." style="width:100%;min-height:150px;padding:12px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:var(--mono);font-size:13px;outline:none;margin-bottom:16px"></textarea>
      <button class="btn btn-primary" onclick="sendBroadcast()">üì¢ –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É</button>
      <div id="bc-result" style="margin-top:16px;font-size:14px;color:var(--green)"></div>
    </div>
  </div>

  <!-- Topics -->
  <div id="page-topics" class="page">
    <div class="page-header"><h2>üî• –ì–æ—Ä—è—á–∏–µ —Ç–µ–º—ã</h2></div>
    <div class="table-card">
      <div class="table-toolbar">
        <h3>–¢–µ–º—ã –¥–Ω—è</h3>
        <button class="btn btn-primary btn-sm" onclick="openTopicModal()">+ –î–æ–±–∞–≤–∏—Ç—å —Ç–µ–º—É</button>
      </div>
      <table>
        <thead><tr><th>#</th><th>–¢–µ–∫—Å—Ç</th><th>–ê–∫—Ç–∏–≤–Ω–∞</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead>
        <tbody id="topics-body"><tr><td colspan="4" style="text-align:center;color:var(--muted);padding:30px">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr></tbody>
      </table>
    </div>
  </div>

  <!-- Promos -->
  <div id="page-promos" class="page">
    <div class="page-header"><h2>üéü –ü—Ä–æ–º–æ–∫–æ–¥—ã</h2></div>
    <div class="table-card">
      <div class="table-toolbar">
        <h3>–ü—Ä–æ–º–æ–∫–æ–¥—ã</h3>
        <button class="btn btn-primary btn-sm" onclick="openPromoModal()">+ –°–æ–∑–¥–∞—Ç—å</button>
      </div>
      <table>
        <thead><tr><th>–ö–æ–¥</th><th>–¢–∞—Ä–∏—Ñ</th><th>–î–Ω–µ–π</th><th>–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π</th><th>–ò—Å—Ç–µ–∫–∞–µ—Ç</th></tr></thead>
        <tbody id="promos-body"><tr><td colspan="5" style="text-align:center;color:var(--muted);padding:30px">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr></tbody>
      </table>
    </div>
  </div>

</div><!-- /main -->

<!-- Modals -->
<div id="modal-overlay" class="modal-overlay" style="display:none" onclick="if(event.target===this)closeModal()">
  <div class="modal" id="modal-content"></div>
</div>

<!-- Toast -->
<div id="toast"></div>

<script>
let _adminPwd = ''; // –ø–∞—Ä–æ–ª—å —Ö—Ä–∞–Ω–∏—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ –ø–∞–º—è—Ç–∏ —Å–µ—Å—Å–∏–∏
let authed = false;
let usersPage = 1, chatsPage = 1;
let chartU, chartC;

function doLogin() {
  const val = document.getElementById('pw-input').value;
  if (val.length >= 4) {
    _adminPwd = val;
    authed = true;
    document.getElementById('login-screen').style.display = 'none';
    document.getElementById('sidebar').style.display = 'flex';
    document.getElementById('main').style.display = 'block';
    initApp();
  } else {
    document.getElementById('login-err').style.display = 'block';
    document.getElementById('pw-input').value = '';
  }
}

function initApp() {
  // Nav
  document.querySelectorAll('nav a').forEach(a => {
    a.addEventListener('click', () => {
      document.querySelectorAll('nav a').forEach(x => x.classList.remove('active'));
      document.querySelectorAll('.page').forEach(x => x.classList.remove('active'));
      a.classList.add('active');
      const page = a.dataset.page;
      document.getElementById('page-' + page).classList.add('active');
      loadPage(page);
    });
  });
  loadDashboard();
  setInterval(loadRealtime, 10000);
  setInterval(updateSidebar, 5000);
  updateSidebar();
}

function loadPage(page) {
  if (page === 'dashboard') loadDashboard();
  else if (page === 'realtime') loadRealtime();
  else if (page === 'users') loadUsers(1);
  else if (page === 'chats') loadChats(1);
  else if (page === 'reports') loadReports();
  else if (page === 'payments') loadPayments();
  else if (page === 'topics') loadTopics();
  else if (page === 'promos') loadPromos();
}

async function api(url, opts={}) {
  const headers = {'Content-Type':'application/json'};
  if (opts.method === 'POST') headers['X-Admin-Password'] = _adminPwd;
  const r = await fetch(url, { headers, ...opts });
  if (r.status === 401) { toast('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å', true); return {}; }
  return r.json();
}

function toast(msg, err=false) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = 'show' + (err?' error':'');
  setTimeout(() => t.className = '', 3000);
}

function fmtDate(d) {
  if (!d) return '‚Äî';
  return new Date(d).toLocaleString('ru', {day:'2-digit',month:'2-digit',hour:'2-digit',minute:'2-digit'});
}

function planBadge(plan) {
  if (!plan || plan==='free') return '<span class="badge badge-free">Free</span>';
  return `<span class="badge badge-${plan}">${plan.toUpperCase()}</span>`;
}

// Dashboard
async function loadDashboard() {
  const s = await api('/stats');
  document.getElementById('s-total').textContent = s.total_users;
  document.getElementById('s-today-users').textContent = `—Å–µ–≥–æ–¥–Ω—è: +${s.active_today||0}`;
  document.getElementById('s-online').textContent = s.online_now;
  document.getElementById('s-active-today').textContent = `–∞–∫—Ç–∏–≤–Ω—ã —Å–µ–≥–æ–¥–Ω—è: ${s.active_today}`;
  document.getElementById('s-chats').textContent = s.total_chats;
  document.getElementById('s-chats-today').textContent = `—Å–µ–≥–æ–¥–Ω—è: ${s.chats_today}`;
  document.getElementById('s-premium').textContent = s.premium_users;
  document.getElementById('s-stars').textContent = s.payments_stars;
  document.getElementById('s-ton').textContent = s.payments_ton;
  document.getElementById('s-reports-count').textContent = s.pending_reports;

  // Charts
  const uLabels = s.daily_users.map(x=>x.day.slice(5));
  const uData   = s.daily_users.map(x=>x.count);
  const cLabels = s.daily_chats.map(x=>x.day.slice(5));
  const cData   = s.daily_chats.map(x=>x.count);
  const chartCfg = (labels, data, color) => ({
    type:'line', data:{
      labels, datasets:[{data, borderColor:color, backgroundColor:color+'22',
      fill:true, tension:0.4, pointRadius:4, pointBackgroundColor:color}]
    },
    options:{plugins:{legend:{display:false}},scales:{
      x:{grid:{color:'rgba(255,255,255,0.04)'},ticks:{color:'#64748b'}},
      y:{grid:{color:'rgba(255,255,255,0.04)'},ticks:{color:'#64748b',stepSize:1}}
    }}
  });
  if (chartU) chartU.destroy();
  if (chartC) chartC.destroy();
  chartU = new Chart(document.getElementById('chart-users'), chartCfg(uLabels, uData, '#00d4ff'));
  chartC = new Chart(document.getElementById('chart-chats'), chartCfg(cLabels, cData, '#ff6432'));

  // Recent reports
  const rData = await api('/reports?status=pending');
  const reports = rData.reports || [];
  document.getElementById('dash-reports-body').innerHTML = reports.length
    ? reports.slice(0,5).map(r=>`<tr>
        <td>${r.id}</td>
        <td>@${r.reporter_name||r.reporter_id}</td>
        <td>@${r.reported_name||r.reported_id}</td>
        <td>${r.reason}</td>
        <td>${fmtDate(r.created_at)}</td>
        <td>
          <button class="btn btn-danger btn-sm" onclick="banUser(${r.reported_id})">–ë–∞–Ω</button>
          <button class="btn btn-ghost btn-sm" onclick="dismissReport(${r.id})">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
        </td></tr>`).join('')
    : '<tr><td colspan="6" style="text-align:center;color:var(--muted);padding:20px">–ñ–∞–ª–æ–± –Ω–µ—Ç üéâ</td></tr>';
}

// Realtime
async function loadRealtime() {
  const d = await api('/realtime');
  document.getElementById('rt-online').textContent = d.online;
  document.getElementById('rt-chats').textContent  = d.active_chats;
  document.getElementById('rt-queue').textContent  = d.queue;
  updateSidebarData(d.online, d.queue);
  document.getElementById('rt-live-body').innerHTML = d.live && d.live.length
    ? d.live.map(s=>`<tr>
        <td>${s.id}</td>
        <td>${s.user_a}</td>
        <td>${s.user_b}</td>
        <td>${fmtDate(s.started_at)}</td>
        <td><button class="btn btn-ghost btn-sm" onclick="viewChat(${s.id})">üëÅ –°–º–æ—Ç—Ä–µ—Ç—å</button></td>
      </tr>`).join('')
    : '<tr><td colspan="5" style="text-align:center;color:var(--muted);padding:20px">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —á–∞—Ç–æ–≤</td></tr>';
}

async function updateSidebar() {
  const d = await api('/realtime');
  updateSidebarData(d.online, d.queue);
}
function updateSidebarData(online, queue) {
  document.getElementById('sb-online').textContent = online;
  document.getElementById('sb-queue').textContent  = queue;
}

// Users
async function loadUsers(page=1) {
  usersPage = page;
  const search = document.getElementById('users-search').value;
  const filter = document.getElementById('users-filter').value;
  const d = await api(`/users?page=${page}&search=${encodeURIComponent(search)}&filter=${filter}`);
  const users = d.users || [];
  document.getElementById('users-body').innerHTML = users.length
    ? users.map(u=>`<tr>
        <td><span style="font-family:var(--mono);font-size:11px">${u.id}</span></td>
        <td>${u.username ? '@'+u.username : '‚Äî'}</td>
        <td>${u.first_name||'‚Äî'}</td>
        <td>${planBadge(u.premium_plan)}${u.is_banned?'<span class="badge badge-banned" style="margin-left:4px">–ë–ê–ù</span>':''}</td>
        <td>${(u.rating||5).toFixed(1)} ‚≠ê</td>
        <td>${u.total_chats||0}</td>
        <td>${u.xp||0}</td>
        <td style="font-size:11px;color:var(--muted)">${fmtDate(u.created_at)}</td>
        <td>
          ${!u.is_banned
            ? `<button class="btn btn-danger btn-sm" onclick="banUser(${u.id})">–ë–∞–Ω</button>`
            : `<button class="btn btn-success btn-sm" onclick="unbanUser(${u.id})">–†–∞–∑–±–∞–Ω</button>`
          }
          <button class="btn btn-ghost btn-sm" onclick="viewUserChats(${u.id})">üí¨</button>
        </td>
      </tr>`).join('')
    : '<tr><td colspan="9" style="text-align:center;color:var(--muted);padding:30px">–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</td></tr>';
  document.getElementById('users-pinfo').textContent = `–°—Ç—Ä. ${page} ¬∑ –≤—Å–µ–≥–æ ${d.total||0}`;
  document.getElementById('users-prev').disabled = page <= 1;
  document.getElementById('users-next').disabled = users.length < 50;
}

// Chats
async function loadChats(page=1) {
  chatsPage = page;
  const filter = document.getElementById('chats-filter').value;
  const d = await api(`/chats?page=${page}&filter=${filter}`);
  const sessions = d.sessions || [];
  document.getElementById('chats-body').innerHTML = sessions.length
    ? sessions.map(s=>`<tr>
        <td>${s.id}</td>
        <td>${s.username_a ? '@'+s.username_a : s.user_a}</td>
        <td>${s.username_b ? '@'+s.username_b : s.user_b}</td>
        <td>${s.messages_count||0}</td>
        <td style="max-width:150px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${s.topic||'‚Äî'}</td>
        <td style="font-size:11px">${fmtDate(s.started_at)}</td>
        <td><span class="badge badge-${s.status}">${s.status==='active'?'–ê–∫—Ç–∏–≤–µ–Ω':'–ó–∞–≤–µ—Ä—à—ë–Ω'}</span></td>
        <td><button class="btn btn-ghost btn-sm" onclick="viewChat(${s.id})">üëÅ –°–º–æ—Ç—Ä–µ—Ç—å</button></td>
      </tr>`).join('')
    : '<tr><td colspan="8" style="text-align:center;color:var(--muted);padding:30px">–ù–µ—Ç —á–∞—Ç–æ–≤</td></tr>';
  document.getElementById('chats-pinfo').textContent = `–°—Ç—Ä. ${page} ¬∑ –≤—Å–µ–≥–æ ${d.total||0}`;
  document.getElementById('chats-prev').disabled = page <= 1;
  document.getElementById('chats-next').disabled = sessions.length < 50;
}

// View chat messages
async function viewChat(sessionId) {
  const d = await api(`/chat_messages?session_id=${sessionId}`);
  const msgs = d.messages || [];
  const typeIcon = {text:'üí¨', photo:'üì∑', video:'üé¨', voice:'üéô', video_note:'üìπ', sticker:'üé≠', document:'üìÑ', audio:'üéµ', animation:'üéû', gift:'üéÅ'};

  let html = `<h3>üí¨ –ß–∞—Ç #${sessionId}</h3>`;
  if (!msgs.length) {
    html += '<p style="color:var(--muted);text-align:center;padding:20px">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</p>';
  } else {
    const firstUser = msgs[0].sender_id;
    html += '<div class="chat-messages">';
    for (const m of msgs) {
      const isLeft = m.sender_id === firstUser;
      const icon = typeIcon[m.msg_type] || '‚ùì';
      const name = m.username ? '@'+m.username : (m.first_name||'User');
      let content = '';
      if (m.msg_type === 'text') {
        content = `<div style="white-space:pre-wrap">${escHtml(m.text_content||'')}</div>`;
      } else if (m.text_content) {
        content = `<div class="msg-file"><span class="file-icon">${icon}</span>${escHtml(m.text_content)}</div>`;
      } else {
        content = `<div class="msg-file"><span class="file-icon">${icon}</span>${m.msg_type}${m.caption?': '+escHtml(m.caption):''}${m.file_unique_id?'<br><small style="color:var(--muted)">ID: '+m.file_unique_id+'</small>':''}</div>`;
      }
      html += `<div class="msg ${isLeft?'left':'right'}">
        <div class="msg-bubble">${content}</div>
        <div class="msg-meta">${name} ¬∑ ${fmtDate(m.sent_at)}</div>
      </div>`;
    }
    html += '</div>';
  }
  html += '<div class="modal-footer"><button class="btn btn-ghost" onclick="closeModal()">–ó–∞–∫—Ä—ã—Ç—å</button></div>';
  openModal(html);
}

function escHtml(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

function viewUserChats(userId) {
  document.querySelector('[data-page="chats"]').click();
  setTimeout(async () => {
    const filter = document.getElementById('chats-filter');
    filter.value = 'all';
    const d = await api(`/chats?page=1&filter=all&user_id=${userId}`);
    const sessions = d.sessions || [];
    document.getElementById('chats-body').innerHTML = sessions.length
      ? sessions.map(s=>`<tr>
          <td>${s.id}</td>
          <td>${s.username_a?'@'+s.username_a:s.user_a}</td>
          <td>${s.username_b?'@'+s.username_b:s.user_b}</td>
          <td>${s.messages_count||0}</td>
          <td>${s.topic||'‚Äî'}</td>
          <td style="font-size:11px">${fmtDate(s.started_at)}</td>
          <td><span class="badge badge-${s.status}">${s.status==='active'?'–ê–∫—Ç–∏–≤–µ–Ω':'–ó–∞–≤–µ—Ä—à—ë–Ω'}</span></td>
          <td><button class="btn btn-ghost btn-sm" onclick="viewChat(${s.id})">üëÅ –°–º–æ—Ç—Ä–µ—Ç—å</button></td>
        </tr>`).join('')
      : '<tr><td colspan="8" style="text-align:center;color:var(--muted);padding:30px">–ß–∞—Ç–æ–≤ –Ω–µ—Ç</td></tr>';
  }, 100);
}

// Reports
async function loadReports() {
  const status = document.getElementById('reports-filter').value;
  const d = await api(`/reports?status=${status}`);
  const reports = d.reports || [];
  document.getElementById('reports-body').innerHTML = reports.length
    ? reports.map(r=>`<tr>
        <td>${r.id}</td>
        <td>@${r.reporter_name||r.reporter_id}</td>
        <td>@${r.reported_name||r.reported_id}</td>
        <td>${r.reason||'‚Äî'}</td>
        <td><button class="btn btn-ghost btn-sm" onclick="viewChat(${r.session_id})">üëÅ</button></td>
        <td style="font-size:11px">${fmtDate(r.created_at)}</td>
        <td><span class="badge badge-${r.status==='pending'?'pending':'active'}">${r.status}</span></td>
        <td>
          <button class="btn btn-danger btn-sm" onclick="banFromReport(${r.id},${r.reported_id})">–ë–∞–Ω</button>
          <button class="btn btn-ghost btn-sm" onclick="dismissReport(${r.id})">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
        </td>
      </tr>`).join('')
    : '<tr><td colspan="8" style="text-align:center;color:var(--muted);padding:30px">–ñ–∞–ª–æ–± –Ω–µ—Ç</td></tr>';
}

// Payments
async function loadPayments() {
  const prov = document.getElementById('pay-filter').value;
  const d = await api(`/payments${prov?'?provider='+prov:''}`);
  const pays = d.payments || [];
  document.getElementById('pay-body').innerHTML = pays.length
    ? pays.map(p=>`<tr>
        <td>${p.id}</td>
        <td>${p.username?'@'+p.username:p.user_id}</td>
        <td>${planBadge(p.plan)}</td>
        <td>${p.provider==='stars'?'‚≠ê Stars':'üíé TON'}</td>
        <td style="font-family:var(--mono)">${p.amount||'‚Äî'}</td>
        <td><span class="badge badge-${p.status==='confirmed'?'confirmed':'pending'}">${p.status}</span></td>
        <td style="font-size:11px">${fmtDate(p.created_at)}</td>
      </tr>`).join('')
    : '<tr><td colspan="7" style="text-align:center;color:var(--muted);padding:30px">–ù–µ—Ç –ø–ª–∞—Ç–µ–∂–µ–π</td></tr>';
}

// Topics
async function loadTopics() {
  const d = await api('/topics');
  const topics = d.topics || [];
  document.getElementById('topics-body').innerHTML = topics.length
    ? topics.map(t=>`<tr>
        <td>${t.id}</td>
        <td>${escHtml(t.text)}</td>
        <td>${t.is_active?'<span class="badge badge-active">–î–∞</span>':'<span class="badge badge-free">–ù–µ—Ç</span>'}</td>
        <td>
          <button class="btn btn-ghost btn-sm" onclick="toggleTopic(${t.id},${!t.is_active})">${t.is_active?'–í—ã–∫–ª':'–í–∫–ª'}</button>
          <button class="btn btn-danger btn-sm" onclick="deleteTopic(${t.id})">–£–¥–∞–ª–∏—Ç—å</button>
        </td>
      </tr>`).join('')
    : '<tr><td colspan="4" style="text-align:center;color:var(--muted);padding:30px">–¢–µ–º –Ω–µ—Ç</td></tr>';
}

// Promos
async function loadPromos() {
  const d = await api('/promos');
  const promos = d.promos || [];
  document.getElementById('promos-body').innerHTML = promos.length
    ? promos.map(p=>`<tr>
        <td style="font-family:var(--mono);font-weight:700">${p.code}</td>
        <td>${planBadge(p.plan)}</td>
        <td>${p.days}</td>
        <td>${p.uses} / ${p.max_uses}</td>
        <td style="font-size:11px">${fmtDate(p.expires_at)}</td>
      </tr>`).join('')
    : '<tr><td colspan="5" style="text-align:center;color:var(--muted);padding:30px">–ü—Ä–æ–º–æ–∫–æ–¥–æ–≤ –Ω–µ—Ç</td></tr>';
}

// Actions
async function banUser(id) {
  if (!confirm(`–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${id}?`)) return;
  await api('/users/ban', {method:'POST', body:JSON.stringify({user_id:id,reason:'–ë–∞–Ω –∏–∑ –ø–∞–Ω–µ–ª–∏'})});
  toast('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω');
  loadUsers(usersPage);
}
async function unbanUser(id) {
  await api('/users/unban', {method:'POST', body:JSON.stringify({user_id:id})});
  toast('‚úÖ –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω');
  loadUsers(usersPage);
}
async function banFromReport(reportId, userId) {
  if (!confirm('–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ –∂–∞–ª–æ–±–µ?')) return;
  await api('/users/ban', {method:'POST', body:JSON.stringify({user_id:userId,reason:'–ë–∞–Ω –ø–æ –∂–∞–ª–æ–±–µ'})});
  await api('/reports/dismiss', {method:'POST', body:JSON.stringify({report_id:reportId,action:'ban'})});
  toast('‚úÖ –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –∏ –∂–∞–ª–æ–±–∞ –∑–∞–∫—Ä—ã—Ç–∞');
  loadReports();
}
async function dismissReport(id) {
  await api('/reports/dismiss', {method:'POST', body:JSON.stringify({report_id:id,action:'dismiss'})});
  toast('–ñ–∞–ª–æ–±–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞');
  loadReports();
}
async function toggleTopic(id, active) {
  await api('/topics/toggle', {method:'POST', body:JSON.stringify({id,active})});
  loadTopics();
}
async function deleteTopic(id) {
  if (!confirm('–£–¥–∞–ª–∏—Ç—å —Ç–µ–º—É?')) return;
  await api('/topics/delete', {method:'POST', body:JSON.stringify({id})});
  loadTopics();
}
async function sendBroadcast() {
  const text = document.getElementById('bc-text').value.trim();
  const audience = document.getElementById('bc-audience').value;
  if (!text) { toast('–í–≤–µ–¥–∏ —Ç–µ–∫—Å—Ç', true); return; }
  if (!confirm(`–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É (${audience})?`)) return;
  const d = await api('/broadcast', {method:'POST', body:JSON.stringify({text,audience})});
  document.getElementById('bc-result').textContent = `‚úÖ –†–∞—Å—Å—ã–ª–∫–∞ –∑–∞–ø—É—â–µ–Ω–∞ –¥–ª—è ${d.total||0} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π`;
  document.getElementById('bc-text').value = '';
}

// Modals
function openModal(html) {
  document.getElementById('modal-content').innerHTML = html;
  document.getElementById('modal-overlay').style.display = 'flex';
}
function closeModal() {
  document.getElementById('modal-overlay').style.display = 'none';
}

function openGrantModal() {
  openModal(`
    <h3>üëë –í—ã–¥–∞—Ç—å Premium</h3>
    <label>User ID</label>
    <input type="number" id="g-uid" placeholder="123456789">
    <label>–¢–∞—Ä–∏—Ñ</label>
    <select id="g-plan"><option value="basic">‚ö° –ë–∞–∑–æ–≤—ã–π</option><option value="pro">üî• –ü—Ä–æ</option><option value="vip">üëë VIP</option></select>
    <label>–î–Ω–µ–π</label>
    <input type="number" id="g-days" value="30">
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn btn-primary" onclick="doGrant()">–í—ã–¥–∞—Ç—å</button>
    </div>
  `);
}
async function doGrant() {
  const uid = parseInt(document.getElementById('g-uid').value);
  const plan = document.getElementById('g-plan').value;
  const days = parseInt(document.getElementById('g-days').value);
  if (!uid || !days) { toast('–ó–∞–ø–æ–ª–Ω–∏ –≤—Å–µ –ø–æ–ª—è', true); return; }
  await api('/users/grant-premium', {method:'POST', body:JSON.stringify({user_id:uid,plan,days})});
  toast('‚úÖ Premium –≤—ã–¥–∞–Ω!');
  closeModal();
}

function openTopicModal() {
  openModal(`
    <h3>üî• –ù–æ–≤–∞—è —Ç–µ–º–∞</h3>
    <label>–¢–µ–∫—Å—Ç —Ç–µ–º—ã</label>
    <input type="text" id="topic-text" placeholder="üí≠ –í–≤–µ–¥–∏ —Ç–µ–º—É —Ä–∞–∑–≥–æ–≤–æ—Ä–∞...">
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn btn-primary" onclick="doAddTopic()">–î–æ–±–∞–≤–∏—Ç—å</button>
    </div>
  `);
}
async function doAddTopic() {
  const text = document.getElementById('topic-text').value.trim();
  if (!text) return;
  await api('/topics/add', {method:'POST', body:JSON.stringify({text})});
  toast('‚úÖ –¢–µ–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞');
  closeModal();
  loadTopics();
}

function openPromoModal() {
  openModal(`
    <h3>üéü –°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥</h3>
    <label>–ö–æ–¥</label>
    <input type="text" id="promo-code" placeholder="SUMMER2025" style="text-transform:uppercase">
    <label>–¢–∞—Ä–∏—Ñ</label>
    <select id="promo-plan"><option value="basic">‚ö° –ë–∞–∑–æ–≤—ã–π</option><option value="pro">üî• –ü—Ä–æ</option><option value="vip">üëë VIP</option></select>
    <label>–î–Ω–µ–π</label>
    <input type="number" id="promo-days" value="30">
    <label>–ö–æ–ª-–≤–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π</label>
    <input type="number" id="promo-uses" value="1">
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn btn-primary" onclick="doCreatePromo()">–°–æ–∑–¥–∞—Ç—å</button>
    </div>
  `);
}
async function doCreatePromo() {
  const code = document.getElementById('promo-code').value.trim().toUpperCase();
  const plan = document.getElementById('promo-plan').value;
  const days = parseInt(document.getElementById('promo-days').value);
  const uses = parseInt(document.getElementById('promo-uses').value);
  if (!code || !days || !uses) { toast('–ó–∞–ø–æ–ª–Ω–∏ –≤—Å–µ –ø–æ–ª—è', true); return; }
  const d = await api('/promo', {method:'POST', body:JSON.stringify({code,plan,days,max_uses:uses})});
  if (d.success) { toast('‚úÖ –ü—Ä–æ–º–æ–∫–æ–¥ —Å–æ–∑–¥–∞–Ω!'); closeModal(); loadPromos(); }
  else toast('‚ùå –¢–∞–∫–æ–π –∫–æ–¥ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç', true);
}
</script>
</body>
</html>
